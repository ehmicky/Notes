
                   
   CLOUDWATCH_LOGS  
                   



TODO ==>
  - CloudTrail: see unfinished "CloudWatch logs" chapter
  - CloudWatch metrics:
     - embedded metrics: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Embedded_Metric_Format.html
     - best practices: https://docs.aws.amazon.com/securityhub/latest/userguide/cloudwatch-controls.html
  - CloudWatch dashboard:
     - DLOG
  - Lambda:
     - https://docs.aws.amazon.com/lambda/latest/dg/urls-monitoring.html
     - https://docs.aws.amazon.com/lambda/latest/dg/nodejs-logging.html
     - https://docs.aws.amazon.com/lambda/latest/dg/monitoring-cloudwatchlogs.html
     - ENVVAR AWS_LAMBDA_LOG_GROUP_NAME, AWS_LAMBDA_LOG_STREAM_NAME
     - Insights:
        - https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Lambda-Insights-metrics.html (second half of page)
        - https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Lambda-Insights-Troubleshooting.html
        - https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Lambda-Insights-example-event.html

Read:
  - Working with log groups and log streams
     - Use Live Tail to view logs in near real time

GOAL ==>                      #Aggregates logs to single place, with rotation, and possibility to create CloudWatch alarms when log line match pattern

VERSION ==>                   #2023-07-17


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:              API              :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


SERVICE_DOMAIN                #logs.amazonaws.com
                              #Can use HTTP[S]

FORMAT ==>                    #JSON
                              #Uses REQ.Action|Version

REQ_ID                        #x-amzn-RequestId [S]

PAGINATION ==>                #REQ.limit NUM (def|max: 50) + REQ|RES.nextToken except:
                              #  - def|max 1e4: StartQuery()
                              #  - def|max 1e4 or 1MB: FilterLogEvents()
                              #  - def|max 1e4 and use RES.nextBackwardToken|nextForwardToken: GetLogEvents()
                              #  - def|max 1e3 and use REQ.maxResults: DescribeQueries|QueryDefinitions()
                              #  - no pagination: DescribeAccountPolicies(), GetLogGroupFields(), TestMetricFilter()

PRICING ==>                   #  - 0.5$/GB read
                              #  - 0.03$/GB stored
                              #  - GetLogEvents(): same price as out traffic on EC2

CloudWatchLogsFullAccess      #AWS managed POLICY allowing logs:*
CloudWatchLogsReadOnlyAccess  #Same but readonly


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:             GROUP             :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


CreateLogGroup()              #Req:
                              #  - only logGroupName, kmsKeyId
                              #Res: empty
PutRetentionPolicy()          #Req:
                              #  - only logGroupName, retentionInDays
                              #Res: empty
DeleteRetentionPolicy()       #Req:
                              #  - only logGroupName
                              #Res: empty
DescribeLogGroups()           #Req LOG_GROUP_REQ
                              #Res: logGroups LOG_GROUP_ARR
                              #  - no tags
DeleteLogGroup()              #Req:
                              #  - only logGroupName
                              #Res: empty

LOG_GROUP                     #Group of LOG_STREAMs
                              #Max 2e4
LOG_GROUP.arn                 #LOG_GROUP_ARN. arn:aws:logs:REGION:ACCOUNT_ID:log-group:LOG_GROUP
LOG_GROUP.logGroupName        #'LOG_GROUP'. Max 512 chars, [[:alnum:]_-/.#]
                              #Can include a NAMEPATH
LOG_GROUP_REQ
 .logGroupNamePrefix          #STR
LOG_GROUP_REQ
 .logGroupNamePattern         #STR
LOG_GROUP.creationTime        #DATE_NUM

LOG_GROUP.retentionInDays     #NUM (def: none) of days before deleting LLEVENTs, among:
                              #  - 1|3|5 days
                              #  - 1-2 weeks
                              #  - 1-6 months
                              #  - 1|1.5|2-10 years

LOG_GROUP.storedBytes         #NUM


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:            STREAM             :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


CreateLogStream()             #Req: LOG_STREAM
                              #  - only logStreamName, logGroupName
                              #Res: empty
DescribeLogStreams()          #Req: LOG_STREAM_REQ
                              #Res: LogStreams LOG_STREAM_ARR
                              #  - no logGroupName
DeleteLogStream()             #Req: LOG_STREAM
                              #  - only logStreamName, logGroupName
                              #Res: empty

LOG_STREAM                    #Series of LLEVENTs
                              #Deleted if empty for 2 months
LOG_STREAM.arn                #LOG_STREAM_ARN. arn:aws:logs:REGION:ACCOUNT_ID:log-group:LOG_GROUP:log-stream:LOG_STREAM
LOG_STREAM.logStreamName      #'LOG_STREAM'
LOG_STREAM_REQ
 .logStreamNamePrefix         #STR
LOG_STREAM.creationTime       #DATE_NUM
LOG_STREAM.lastIngestionTime  #DATE_NUM
LOG_STREAM.firstEventTimestamp#DATE_NUM
LOG_STREAM.lastEventTimestamp #DATE_NUM

LOG_STREAM[_REQ]
 |METRIC_FILTER.logGroupName  #'LOG_GROUP'
LOG_STREAM_REQ
 .logGroupIdentifier          #'LOG_GROUP'|LOG_GROUP_ARN

LOG_STREAM_REQ.orderBy        #'LogStreamName' (def) or 'LastEventTime'
LOG_STREAM_REQ.descending     #BOOL (def: false). Sorting order


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:            EVENTS             :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutLogEvents()                #Req: LLEVENTS
                              #  - no LLEVENT.ingestionTime
                              #Res: LLEVENTS_NEW
GetLogEvents()                #Req: LLEVENTS_REQ
                              #  - no filterPattern, logStreamNamePrefix
                              #Res: events LLEVENT_ARR
FilterLogEvents()             #Req: LLEVENTS_REQ
                              #  - logStreamName STR -> logStreamNames STR_ARR + logStreamNamePrefix STR
                              #  - no startFromHead
                              #Res: events LLEVENT_ARR, searchedLogStreams LLEVENTS_RES_ARR

LLEVENTS                      #
LLEVENTS[_REQ|RES]
 .logStreamName               #'LOG_STREAM'

LLEVENTS_REQ.startTime|endTime#DATE_NUM. Filter by LLEVENT.timestamp
LLEVENTS_REQ.startFromHead    #BOOL (def: true). asc|desc sorting order.
                              #Always sorted by LLEVENT.timestamp

LLEVENTS[_REQ].logGroupName   #'LOG_GROUP'
LLEVENTS_REQ
 .logGroupIdentifier          #'LOG_GROUP'|LOG_GROUP_ARN

LLEVENTS_REQ.filterPattern    #'FILTER_PATTERN', either:
                              #  - STR:
                              #     - pattern triggering metric
                              #     - can be '' for any log event
                              #  - [VAR[=|>|<|>=|<=|!=VAL],...]:
                              #     - for tab-delimited log lines, when a field equals VAL
                              #     - VAR can be '...' at beginning, middle or end
                              #STR and VAL can use globbing

LLEVENTS_REQ|QUERY_RECORD_REQ #BOOL. If false (def), sensitive data are masked
 .unmask                      #If true, requires PACTION logs:Unmask

LLEVENTS.logEvents            #LLEVENT_ARR
LLEVENT                       #Log message
LLEVENT.timestamp             #DATE_NUM of event being logged
LLEVENT.ingestionTime         #DATE_NUM of LLEVENT itelf
LLEVENT.message               #STR

LLEVENTS_RES
 .searchedCompletely          #BOOL. Whether all LLEVENTs in LOG_STREAM were searched

LLEVENTS_NEW
 .rejectedLogEventsInfo       #LLEVENTS_REJECT
LLEVENTS_REJECT
 .expiredLogEventEndIndex     #NUM
LLEVENTS_REJECT
 .tooNewLogEventStartIndex    #NUM
LLEVENTS_REJECT
 .tooOldLogEventEndIndex      #NUM

LIVE TAIL ==>                 #View LLEVENTs as they come
                              #Can filter by LOG_GROUPs|LOG_STREAMs|FILTER_PATTERNs
                              #Can highlight specific words
                              #Requires PACTION logs:Start|StopLiveTail


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:            METRIC             :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutMetricFilter()             #Req: METRIC_FILTER
                              #  - no creationTime
                              #Res: empty
DescribeMetricFilters()       #Req: METRIC_FILTER|METRIC_TRANSFORM
                              #  - only logGroupName, metricName, metricNamespace
                              #  - only filterName -> filterNamePrefix STR
                              #Res: metricFilters METRIC_FILTER_ARR
DeleteMetricFilter()          #Req: METRIC_FILTER
                              #  - only filterName, logGroupName
                              #Res: empty

METRIC_FILTER                 #Create METRIC_DATA from LLEVENTs
METRIC_FILTER.filterName      #'METRIC_FILTER'
METRIC_FILTER.creationTime    #DATE_NUM

METRIC_FILTER|TEST_FILTER_REQ
 .filterPattern               #'FILTER_PATTERN'

METRIC_FILTER
 .metricTransformations       #METRIC_TRANSFORM_ARR
METRIC_TRANSFORM.metricName   #'METRIC'. METRIC.MetricName
METRIC_TRANSFORM
 .metricNamespace             #'NAMESPACE'. METRIC.Namespace
METRIC_TRANSFORM.dimensions   #OBJ. METRIC.Dimensions
METRIC_TRANSFORM.metricValue  #STR. METRIC_DATUM.Value
METRIC_TRANSFORM.defaultValue #NUM
METRIC_TRANSFORM.unit         #STR. METRIC_DATUM.Unit

LOG_GROUP.metricFilterCount   #NUM

TestMetricFilter()            #Req: TEST_FILTER_REQ
                              #Res: matches TEST_FILTER_RES_ARR

TEST_FILTER_REQ
 .logEventMessages            #STR_ARR

TEST_FILTER_RES.eventMessage  #STR
TEST_FILTER_RES.eventNumber   #NUM
TEST_FILTER_RES
 .extractedValues             #{ VAR: STR, ... }


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:             QUERY             :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


StartQuery()                  #Req: QUERY
                              #  - logGroupIdentifiers -> logGroupIdentifiers + logGroupName[s] STR[_ARR]
                              #  - no queryId, createTime, status
                              #Res: QUERY
                              #  - only queryId
                              #Paginates QUERY_RESULTS.results for GetQueryResults()
DescribeQueries()             #Req: QUERY
                              #  - only logGroupIdentifiers -> logGroupName STR
                              #  - only status
                              #Res: queries QUERY_ARR
                              #  - logGroupIdentifiers -> logGroupName STR
                              #  - no startTime|endTime
StopQuery()                   #Req: QUERY
                              #  - only queryId
                              #Res: QUERY
                              #  - only status -> success BOOL
GetQueryResults()             #Req: QUERY
                              #  - only queryId
                              #Res: QUERY_RESULTS

QUERY.queryId                 #QUERY_MID
QUERY.createTime              #DATE_NUM

QUERY.queryString             #STR

QUERY.logGroupIdentifiers     #'LOG_GROUP'|LOG_GROUP_ARN_ARR
                              #Max 50

QUERY.startTime|endTime       #DATE_NUM

QUERY_RESULTS.results         #QUERY_RESULT_ARR_ARR
QUERY_RESULT.field            #STR
QUERY_RESULT.value            #STR

QUERY[_RESULTS].status        #STR among:
                              #  - Scheduled
                              #  - Running
                              #  - Complete
                              #  - Failed, Cancelled, Timeout
                              #  - Unknown

QUERY_RESULTS.statistics      #QUERY_STATS
QUERY_STATS.recordsMatched    #NUM
QUERY_STATS.recordsScanned    #NUM
QUERY_STATS.bytesScanned      #NUM


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:       QUERY DEFINITION        :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutQueryDefinition()          #Req: QUERYDEF
                              #  - no lastModified
                              #Res: QUERYDEF
                              #  - only queryDefinitionId
DescribeQueryDefinitions()    #Req: QUERYDEF
                              #  - only name -> queryDefinitionNamePrefix STR
                              #Res: queryDefinitions QUERYDEF_ARR
DeleteQueryDefinition()       #Req: QUERYDEF
                              #  - only queryDefinitionId
                              #Res: success BOOL

QUERYDEF.queryDefinitionId    #QUERYDEF_MID
QUERYDEF.name                 #'QUERYDEF'
QUERYDEF.lastModified         #DATE_NUM

QUERYDEF.queryString          #STR

QUERYDEF.logGroupNames        #'LOG_GROUP'_ARR


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:         QUERY RECORD          :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


GetLogRecord()                #Req: QUERY_RECORD_REQ
                              #Res: QUERY_RECORD_RES

QUERY_RECORD_REQ
 .logRecordPointer            #STR

QUERY_RECORD_RES.logRecord    #OBJ


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:         QUERY FIELDS          :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


GetLogGroupFields()           #Req: QUERY_FIELDS_REQ
                              #Res: logGroupFields QUERY_FIELD_ARR

QUERY_FIELDS_REQ
 .logGroupIdentifier          #'LOG_GROUP'|LOG_GROUP_ARN
QUERY_FIELDS_REQ.logGroupName #'LOG_GROUP'

QUERY_FIELDS_REQ.time         #DATE_NUM

QUERY_FIELD.name              #STR
QUERY_FIELD.percent           #NUM


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:         SUBSCRIPTION          :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutSubscriptionFilter()       #Req: SUBSCRIPTION
                              #  - no creationTime
                              #Res: empty
DescribeSubscriptionFilters() #Req: SUBSCRIPTION
                              #  - only filterName -> filterNamePrefix STR
                              #  - only logGroupName
                              #Res: subscriptionFilters SUBSCRIPTION_ARR
DeleteSubscriptionFilter()    #Req: SUBSCRIPTION
                              #  - only filterName, logGroupName
                              #Res: empty

SUBSCRIPTION.filterName       #'SUBSCRIPTION'
SUBSCRIPTION.creationTime     #DATE_NUM

SUBSCRIPTION.logGroupName     #'LOG_GROUP'

SUBSCRIPTION.destinationArn   #DESTINATION_ARN
SUBSCRIPTION.roleArn          #ROLE_ARN
                              #Requires PACTION iam:PassRole

SUBSCRIPTION.filterPattern    #'FILTER_PATTERN'
SUBSCRIPTION.distribution     #'Random' or 'ByLogStream'


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:          DESTINATION          :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutDestination()              #Req: DESTINATION
                              #  - no arn, creationTime, accessPolicy, forceUpdate
                              #Res: destination DESTINATION
                              #  - no tags, forceUpdate
PutDestinationPolicy()        #Req: DESTINATION
                              #  - only destinationName, accessPolicy, forceUpdate
                              #Res: empty
DescribeDestinations()        #Req: DESTINATION
                              #  - only destinationName -> destinationNamePrefix STR
                              #Res: destinations DESTINATION_ARR
                              #  - no tags, forceUpdate
DeleteDestination()           #Req: DESTINATION
                              #  - only destinationName
                              #Res: empty

DESTINATION.arn               #DESTINATION_ARN. arn:aws:logs:REGION:ACCOUNT_ID:destination:DESTINATION
DESTINATION.destinationName   #'DESTINATION'
DESTINATION.creationTime      #DATE_NUM

DESTINATION.targetArn         #ARN

DESTINATION.accessPolicy      #IAM 'POLICY'
DESTINATION.roleArn           #ROLE_ARN
                              #Requires PACTION iam:PassRole
DESTINATION.forceUpdate       #BOOL


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:            EXPORT             :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


CreateExportTask()            #Req: EXPORT
                              #  - no taskId, executionInfo, status
                              #Res: EXPORT
                              #  - only taskId
DescribeExportTasks()         #Req: EXPORT
                              #  - only taskId, statusCode
                              #Res: exportTasks EXPORT_ARR
                              #  - no logStreamNamePrefix
CancelExportTask()            #Req: EXPORT
                              #  - only taskId
                              #Res: empty

EXPORT.taskId                 #EXPORT_MID
EXPORT.taskName               #'EXPORT'
EXPORT.destination            #S3 'BUCKET'
EXPORT.destinationPrefix      #S3 'OBJECT' prefix
EXPORT
 .executionInfo.creationTime  #DATE_NUM

EXPORT.logGroupName           #'LOG_GROUP'
EXPORT.logStreamNamePrefix    #STR
EXPORT.from|to                #DATE_NUM

EXPORT.status.code            #STR among:
                              #  - PENDING
                              #  - RUNNING
                              #  - PENDING_CANCEL, CANCELLED
                              #  - COMPLETED, FAILED
EXPORT.status.message         #STR
EXPORT
 .executionInfo.completionTime#DATE_NUM


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:              KMS              :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


AssociateKmsKey()             #Req: KMS_ASSOC
                              #Res: empty
DisassociateKmsKey()          #Req: KMS_ASSOC
                              #  - no kmsKeyId
                              #Res: empty

KMS_ASSOC                     #Sets default KMS_KEY_ID for LOG_GROUP|QUERY_RES
KMS_ASSOC.kmsKeyId            #KMS_KEY_ID
KMS_ASSOC.logGroupName        #'LOG_GROUP'
KMS_ASSOC.resourceIdentifier  #Either:
                              #  - LOG_GROUP_ARN
                              #  - 'arn:aws:logs:REGION:ACCOUNT_ID:query-result:*'

LOG_GROUP.kmsKeyId            #KMS_KEY_ID. Encrypt LLEVENTs at-rest
QUERY_RES.encryptionKey       #KMS_KEY_ID


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:        POLICY RESOURCE        :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutResourcePolicy()           #Req: LOG_GROUP_POLICY
                              #  - no lastUpdatedTime
                              #Res: resourcePolicy LOG_GROUP_POLICY
DescribeResourcePolicies()    #Req: empty
                              #Res: resourcePolicies LOG_GROUP_POLICY_ARR
DeleteResourcePolicy()        #Req: LOG_GROUP_POLICY
                              #  - only policyName
                              #Res: empty

LOG_GROUP_POLICY.policyName   #'LOG_GROUP_POLICY'
LOG_GROUP_POLICY
 .lastUpdatedTime             #DATE_NUM

LOG_GROUP_POLICY
 .policyDocument              #IAM 'POLICY'

PACTION logs:Create|Update|Get|List|DeleteLogDelivery???


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:        POLICY ACCOUNT         :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutAccountPolicy()            #Req: ACCOUNT_POLICY
                              #  - no lastUpdatedTime, accountId
                              #Res: accountPolicy ACCOUNT_POLICY
DescribeAccountPolicies()     #Req: ACCOUNT_POLICY
                              #  - only policyName, policyType
                              #  - only accountId -> accountIdentifiers ACCOUNT_ID_ARR
                              #Res: accountPolicies ACCOUNT_POLICY_ARR
DeleteAccountPolicy()         #Req: ACCOUNT_POLICY
                              #  - only policyName, policyType
                              #Res: empty

ACCOUNT_POLICY.policyName     #'ACCOUNT_POLICY'
ACCOUNT_POLICY.lastUpdatedTime#DATE_NUM

ACCOUNT_POLICY.policyDocument #IAM 'POLICY'
                              #Max 30KB

ACCOUNT_POLICY.accountId      #ACCOUNT_ID
ACCOUNT_POLICY.policyType     #Always 'DATA_PROTECTION_POLICY'
ACCOUNT_POLICY.scope          #Always 'ALL'

LOG_GROUP_REQ
 .includeLinkedAccounts       #BOOL (def: false)
LOG_GROUP_REQ                 #ACCOUNT_ID_ARR. Only if includeLinkedAccounts true
 .accountIdentifiers          #Max 20


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:    POLICY DATA PROTECTION     :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PutDataProtectionPolicy()     #Req: DATA_POLICY
                              #  - no lastUpdatedTime
                              #Res: DATA_POLICY
GetDataProtectionPolicy()     #Req: DATA_POLICY
                              #  - only logGroupIdentifier
                              #Res: DATA_POLICY
DeleteDataProtectionPolicy()  #Req: DATA_POLICY
                              #  - only logGroupIdentifier
                              #Res: empty

DATA_POLICY.logGroupIdentifier#'LOG_GROUP'|LOG_GROUP_ARN
DATA_POLICY.lastUpdatedTime   #DATE_NUM

DATA_POLICY.policyDocument    #IAM 'POLICY'

LOG_GROUP.dataProtectionStatus#STR among:
                              #  - ACTIVATED
                              #  - DISABLED
                              #  - DELETED, ARCHIVED
LOG_GROUP.inheritedProperties #Can only be 'ACCOUNT_DATA_PROTECTION'


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:             TAGS              :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


ListTagsForResource()         #Req: RESOURCE_TAGS
                              #  - only resourceArn
                              #Res: RESOURCE_TAGS
                              #  - no resourceArn
TagResource()                 #Req: RESOURCE_TAGS
                              #Res: empty
UntagResource()               #Req: RESOURCE_TAGS
                              #  - tags -> tagKeys STR_ARR
                              #Res: empty

RESOURCE_TAGS                 #
RESOURCE_TAGS.resourceArn     #LOG_GROUP|DESTINATION_ARN
RESOURCE_TAGS.tags            #TAGS

LOG_GROUP|DESTINATION.tags    #TAGS
