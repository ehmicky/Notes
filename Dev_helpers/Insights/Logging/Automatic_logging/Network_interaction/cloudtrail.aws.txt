
              
   CLOUDTRAIL  
              



TO DOCUMENT ==>
  - https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/logging_cw_api_calls.html
  - IAM: https://docs.aws.amazon.com/IAM/latest/UserGuide/cloudtrail-integration.html
  - Glacier: https://docs.aws.amazon.com/amazonglacier/latest/dev/audit-logging.html
  - S3:
     - https://docs.aws.amazon.com/AmazonS3/latest/userguide/cloudtrail-logging.html
     - https://docs.aws.amazon.com/AmazonS3/latest/userguide/logging-with-S3.html
     - see common fields with NPAYLOAD (https://docs.aws.amazon.com/AmazonS3/latest/userguide/notification-content-structure.html)
     - JOBs: https://docs.aws.amazon.com/AmazonS3/latest/userguide/batch-ops-examples-event-bridge-cloud-trail.html

VERSION ==>                       #2014-08-27

GOAL ==>                          #Logs API calls:
                                  #  - made by user or by AWS services


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:              API              :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


FORMAT ==>                        #JSON

PRICING ==>                       #Free (except S3|SNS costs)


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:          TRAIL MAIN           :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


Create|UpdateTrail()              #Req: TRAIL
                                  #Res: TRAIL
DescribeTrails()                  #Req: TRAIL
                                  #  - only Name -> trailNameList 'TRAIL'_ARR
                                  #Response: TrailList TRAIL_ARR
DeleteTrail()                     #Req: TRAIL
                                  #  - only name
                                  #Res: empty

TRAIL                             #Max 1 per USER
TRAIL.Name                        #'TRAIL'

TRAIL.IncludeGlobalServiceEvents  #BOOL (def: true). Whether to include global SERVICEs (e.g. IAM)
                                  #LOG_FILE is REGION-wise, i.e. global SERVICEs are duplicated per REGION
                                  #Should set to false in all REGIONs but one


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:         TRAIL STATUS          :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


StartLogging|StopLogging()        #Req: TRAIL
                                  #  - only Name
                                  #Res: empty
                                  #Sets TRAIL_STATUS.IsLogging
GetTrailStatus()                  #Req: TRAIL
                                  #  - only Name
                                  #Res: TRAIL_STATUS

TRAIL_STATUS.IsLogging            #BOOL
TRAIL_STATUS.StartLoggingTime     #DATE_NUM
TRAIL_STATUS.StopLoggingTime      #DATE_NUM

LOG DELIVERY ==>                  #LOG_FILE created every 5 mins
                                  #Calls take 15 mins to come
TRAIL_STATUS.LatestDeliveryError  #Last log delivery 'ERROR'
TRAIL_STATUS.LatestDeliveryTime   #DATE_NUM


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:          PERMISSIONS          :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


PERMISSIONS ==>                   #Logger is Principal arn:aws:iam::ACCOUNT_ID:root
                                  #  - ACCOUNT_ID is REGION-specific (see online doc for value)
                                  #Must be allowed PACTIONs:
                                  #  - s3:GetBucketAcl on arn:aws:s3:::LOG_BUCKET
                                  #  - s3:PutObject on arn:aws:s3:::LOG_BUCKET/TRAIL_PREFIX/AWSLogs/ACCOUNT_ID/*
                                  #     - with COND_KEY s3:x-amz-acl 'bucket-owner-full-control'
                                  #  (if SNS)
                                  #  - SNS:Publish on arn:aws:sns:REGION:ACCOUNT_ID:TOPIC


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:              SNS              :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


TRAIL.SnsTopicName                #'SNS_TOPIC' to send on log delivery, with SNS_PAYLOAD

SNS_PAYLOAD.s3Bucket              #'LOG_BUCKET'
SNS_PAYLOAD.s3ObjectKey           #'LOG_FILE'

TRAIL_STATUS
 .LatestNotificationError
TRAIL_STATUS
 .LatestNotificationTime          #Same as LatestDelivery* but for SNS notifications


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:           LOG FILE            :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


TRAIL.S3BucketName                #S3 'LOG_BUCKET' to store LOG_FILE
                                  #Can use S3 to encrypt, archive|rotate, etc.
TRAIL.S3KeyPrefix                 #'TRAIL_PREFIX' (def: none)

TRAIL_PREFIX/AWSLogs/ACCOUNT_ID
 /CloudTrail/REGION/YYYY/MM/DD
 /ACCOUNT_ID_CloudTrail_
  REGION_RANDOM.json.gz           #'LOG_FILE'

                                  #  - sign-in attempts to AWS console, AWS forums or AWS support center,
                                  #    with PACTION 'ConsoleLogin' and SERVICE_DOMAIN 'signin.amazonaws.com'

LOG_FILE                          #
LOG_FILE.Records                  #LOG_EVENT_ARR
LOG_EVENT.eventVersion            #Always '1.02'
LOG_EVENT.eventSource             #'SERVICE_DOMAIN'
LOG_EVENT.eventName               #'ACTION'
LOG_EVENT.awsRegion               #'REGION'
LOG_EVENT.requestParameters       #PARAMS_OBJ
LOG_EVENT.responseElements        #RESP_OBJ
LOG_EVENT.eventTime               #'DATE'
LOG_EVENT.sourceIPAddress         #'IP'
LOG_EVENT.userAgent               #STR of User-Agent [C]
LOG_EVENT.requestId               #REQ_ID
LOG_EVENT.eventId                 #STR. Unique accross all events for a given ACTION
LOG_EVENT.errorCode               #NUM
LOG_EVENT.errorMessage            #STR

LOG_EVENT.userIdentity            #IDENTITY
IDENTITY|ISSUER.type              #One of: 'IAMUser', 'Root', 'AssumedRole', 'FederatedUser'
IDENTITY|ISSUER.arn               #IDENTITY ARN, e.g. ROLE_ARN
IDENTITY|ISSUER.principalId       #IDENTITY ID, e.g. ROLE_MID
IDENTITY|ISSUER.userName          #'IDENTITY' name, e.g. 'ROLE'
IDENTITY|ISSUER.accountId         #ACCOUNT_ID
IDENTITY.accessKeyId              #ACCESS_KEY_ID
IDENTITY.invokedBy                #'SERVICE_DOMAIN', if called by another SERVICE

IDENTITY.sessionContext           #SESSION_CONTEXT. Only if type 'AssumedRole'
SESSION_CONTEXT.sessionIssuer     #ISSUER
SESSION_CONTEXT.attributes        #SESSION_ATTRS
SESSION_ATTRS.mfaAuthenticated    #'BOOL'
SESSION_ATTRS.creationDate        #'DATE'

IDENTITY.webIdFederationData      #FEDERATION_DATA. Only if type 'FederatedUser'
FEDERATION_DATA.federatedProvider #'DOMAIN'
FEDERATION_DATA.attributes        #STR
