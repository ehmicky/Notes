
                                  ┏━━━━━━━━━┓
                                  ┃   SNS   ┃
                                  ┗━━━━━━━━━┛

VERSION ==>                       #2024-09-24

TODO:
  - https://docs.aws.amazon.com/sns/latest/dg/welcome.html
     - stopped at: Amazon SNS event sources and destinations
     - already done:
        - Security > Logging and monitoring
  - https://docs.aws.amazon.com/sns/latest/dg/sns-fork-pipeline-as-subscriber.html
  - https://aws.amazon.com/sns/faqs
  - https://aws.amazon.com/sns/pricing
  - search projects on GitHub
  - add summary
  - update aws_list_services with what SNS does

                                  ┌─────────┐
                                  │   API   │
                                  └─────────┘

NAME ==>                          #Simple Notification Service

SERVICE_DOMAIN                    #sns.amazonaws.com

SVERSION                          #'2010-03-31'

FORMAT ==>                        #Request: query parameters (ARR uses VAR.NUM)
                                  #Response: XML
                                  #Uses REQ.Action|Version

REQ_ID                            #RES.ResponseMetadata.RequestId

PAGINATION ==>                    #Uses REQ|RES.NextToken
                                  #Uses REQ.MaxResults only with:
                                  #  - ListOriginationNumbers() (def|max 30)
                                  #  - ListSMSSandboxPhoneNumbers() (def|max 100)
                                  #No pagination: ListTagsForResource()
                                  #Others: page size always 100

THROTTLING ==>                    #3000|900|150|30/s (REGION-specific, soft): *Topic*(), ConfirmSubscription(),
                                  # *SubscriptionAttributes(), GetDataProtectionPolicy(), *Platform|Endpoint*()
                                  #100/s: [Un]Subscribe()
                                  #50/s: CheckIfPhoneNumberIsOptedOut()
                                  #30/s: ListTopics(), ListSubscriptions[ByTopic](), ListEndpointsByPlatformApplication()
                                  #20/s: GetSMSAttributes(), OptInPhoneNumber()
                                  #15/s: ListPlatformApplications()
                                  #10/s: *Permission*(), *Tag*(), ListPhoneNumbersOptedOut(), GetSMSSandboxAccountStatus()
                                  #1/s (soft): PutDataProtectionPolicy()
                                  #1/s: *SMSSandboxPhoneNumber*(), SetSMSAttributes(), ListOriginationNumbers()

                                  ┌──────────┐
                                  │   AUTH   │
                                  └──────────┘

AmazonSNSFullAccess               #AWS managed POLICY. Allows all 'sns:*' PACTIONs
                                  #Also allows sms-voice:PACTION (SMS|Voice with AWS End User Messaging):
                                  #  - DestinationNumber*, SendTextMessage, SetTextMessageSpendLimitOverride, DescribeAccountAttributes,
                                  #    DescribeSpendLimits, DescribePhoneNumbers, DescribeOptedOutNumbers, DeleteOptedOutNumber
                                  #  - COND_KEY aws:CalledViaLast 'sns.amazonaws.com'
AmazonSNSReadOnlyAccess           #Same but readonly

                                  ┌─────────────┐
                                  │   METRICS   │
                                  └─────────────┘

AWS/Usage/CallCount               #NUM of API calls
                                  #With DVAR Resource 'PACTION'

                                  ┌───────────┐
                                  │   TOPIC   │
                                  └───────────┘

TOPIC                             #Forwards MESSAGEs to SUBs
                                  #Creating|deleting is idempotent
                                  #Max 1e5 (soft) non-FIFO TOPICs, 1e3 (soft) FIFO TOPICs
TOPIC.TopicArn                    #'TOPIC_ARN'. 'arn:aws:sns:REGION:ACCOUNT_ID:TOPIC'
TOPIC.Name                        #'TOPIC'
                                  #Max 256 chars, [:alnum:]-_
TOPIC.Attributes                  #TOPIC_ATTRS

TOPIC_ATTRS.TracingConfig         #'PassThrough' or 'Active'. X-Ray settings
                                  #Not on FIFO

                                  ┌───────────────┐
                                  │   TOPIC API   │
                                  └───────────────┘

CreateTopic()                     #Req: TOPIC
                                  #  - no TopicArn
                                  #  - Attributes: no Owner, EffectiveDeliveryPolicy, Subscriptions*,
                                  #    BeginningArchiveTime, *Feedback*
                                  #Res: TOPIC
                                  #  - only TopicArn
SetTopicAttributes()              #Req: TOPIC
                                  #  - only TopicArn, Attributes -> AttributeName 'TOPIC_ATTR', AttributeValue STR
                                  #  - Attributes: no Owner, EffectiveDeliveryPolicy, Subscriptions*,
                                  #    BeginningArchiveTime, FifoTopic
                                  #Res: empty
ListTopics()                      #Req: empty
                                  #Res: Topic TOPIC_ARR
                                  #  - only TopicArn
GetTopicAttributes()              #Req: TOPIC
                                  #  - only TopicArn
                                  #Res:
                                  #  - only Attributes: no *Feedback*
                                  #  - only TopicArn -> Attributes.TopicArn
DeleteTopic()                     #Req: TOPIC
                                  #  - only TopicArn
                                  #Res: empty

                                  ┌───────────────┐
                                  │   TOPIC IAC   │
                                  └───────────────┘

AWS::SNS::Topic                   #RESPROPs: TopicName, TracingConfig
                                  #RESATTRs: TopicArn, TopicName

new Topic(...CARGS[, CTOPIC_OPTS])#CTOPIC
Topic.fromTopicAttributes
 (...CARGS, OPTS)->ICTOPIC        #Using OPTS: topicArn, contentBasedDeduplication
Topic.fromTopicArn
 (...CARGS, 'TOPIC_ARN')->ICTOPIC #Same but only setting OPTS.topicArn

ICTOPIC.topicArn                  #'TOPIC_ARN'[_TK]
CTOPIC_OPTS.topicName             #TOPIC.Name
ICTOPIC.topicName                 #'TOPIC'[_TK]

CTOPIC_OPTS.tracingConfig         #TOPIC_ATTRS.TracingConfig

                                  ┌───────────────┐
                                  │   TOPIC SAM   │
                                  └───────────────┘

SNSCrudPolicy                     #SAM POLICY_TEMPLATE (see its doc) that allows:
                                  #  - PACTION sns:CreateTopic|SetTopicAttributes, sns:Subscribe|ListSubscriptionsByTopic and sns:Publish
                                  #  - on 'TOPIC*'
                                  #     - using POLICY_TEMPLATE_PARAMS.TopicName

                                  ┌────────────────────┐
                                  │   TOPIC COMPOSER   │
                                  └────────────────────┘

TOPIC ENHANCEMENT COMPONENT ==>   #Includes only TOPIC

                                  ┌───────────────────┐
                                  │   TOPIC METRICS   │
                                  └───────────────────┘

DVAR TopicName                    #'TOPIC'
                                  #Sent with all METRICs except AWS/SNS/SMSMonthToDateSpentUSD|SMSSuccessRate
                                  #TOPIC is also sent as a metric TELEMETRY_ENTITY

INACTIVE TOPIC ==>                #TOPIC without any API calls for 6h+
                                  #Does not send any more METRICs
                                  #API calls includes GetTopicAttributes(), i.e. can be used to re-activate
                                  #Re-activating takes up to 15m

AWS/Usage/ResourceCount           #NUM of TOPICs
                                  #With DVAR Resource 'ApproximateNumberOfTopics'

                                  ┌───────────────────────┐
                                  │   TOPIC METRICS IAC   │
                                  └───────────────────────┘

ICTOPIC.metric
 ('METRIC'[, CMETRIC_OPTS])
 ->CMETRIC                        #Also sets DVAR TopicName

CFACADE.monitorSnsTopic
 (CXMONITORING_OPTS)              #See cdk-monitoring-constructs doc
CXMONITORING_OPTS.topic           #ICTOPIC

                                  ┌────────────────┐
                                  │   TOPIC TAGS   │
                                  └────────────────┘

TOPIC_TAGS.ResourceArn            #'TOPIC_ARN'
TOPIC[_TAGS].Tags                 #TAG_PAIRS

                                  ┌────────────────────┐
                                  │   TOPIC TAGS API   │
                                  └────────────────────┘

TagResource()                     #Req: TOPIC_TAGS
                                  #Res: empty
ListTagsForResource()             #Req: TOPIC_TAGS
                                  #  - only ResourceArn
                                  #Res: TOPIC_TAGS
                                  #  - only Tags
UntagResource()                   #Req: TOPIC_TAGS
                                  #  - Tags OBJ -> TagKeys STR_ARR
                                  #Res: empty

                                  ┌────────────────────┐
                                  │   TOPIC TAGS IAC   │
                                  └────────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: Tags TAG_PAIRS

                                  ┌──────────────────┐
                                  │   SUBSCRIPTION   │
                                  └──────────────────┘

SUB                               #Forwards MESSAGEs to an endpoint
                                  #Must be same ACCOUNT|REGION as TOPIC
                                  #Can be multiple per TOPIC ("Fanout")
                                  #Max 12.5e6 (soft) per non-FIFO TOPIC, 100 (soft) per FIFO TOPIC
SUB.SubscriptionArn               #'SUB_ARN'. 'TOPIC_ARN:SUB_MID'
SUB.TopicArn                      #'TOPIC_ARN'
SUB.Attributes                    #SUB_ATTRS

SUB.Protocol                      #'PROTOCOL':
                                  #  - "A2A" (Application-to-application): HTTP, Lambda, SQS, Kinesis
                                  #  - "A2P" (Application-to-person): email, SMS, push
                                  #     - "custom-managed": A2P or HTTP
                                  #Each documented below
SUB.Endpoint                      #PROTOCOL-specific destination, defined below

TOPIC_ATTRS.SubscriptionsDeleted  #NUM of Unsubscribe()

                                  ┌───────────────────────┐
                                  │   SUBSCRIPTION AUTH   │
                                  └───────────────────────┘

COND_KEY sns:Protocol
COND_KEY sns:Endpoint             #SUB.*. Only with Subscribe()

                                  ┌──────────────────────┐
                                  │   SUBSCRIPTION API   │
                                  └──────────────────────┘

Subscribe()                       #Req: SUB
                                  #  - no SubscriptionArn, Owner
                                  #  - Attributes: no *Confirmation*, EffectiveDeliveryPolicy
                                  #Res: SUB
                                  #  - only SubscriptionArn
SetSubscriptionAttributes()       #Req: SUB
                                  #  - only SubscriptionArn, Attributes -> AttributeName 'SUB_ATTR', AttributeValue STR
                                  #  - Attributes: no *Confirmation*, EffectiveDeliveryPolicy
                                  #Res: empty
ListSubscriptions()               #Req: empty
                                  #Res: Subscriptions SUB_ARR
                                  #  - no Attributes, ReturnSubscriptionArn
ListSubscriptionsByTopic()        #Req: SUB
                                  #  - only TopicArn
                                  #Res: Subscriptions SUB_ARR
                                  #  - no Attributes, ReturnSubscriptionArn
GetSubscriptionAttributes()       #Req: SUB
                                  #  - only SubscriptionArn
                                  #Res: SUB
                                  #  - only Attributes
                                  #  - only Owner|*Arn -> Attributes.Owner|*Arn
Unsubscribe()                     #Req: SUB
                                  #  - only SubscriptionArn
                                  #Res: empty

                                  ┌──────────────────────┐
                                  │   SUBSCRIPTION IAC   │
                                  └──────────────────────┘

AWS::SNS::Subscription            #RESPROPs: TopicArn, Protocol, Endpoint
                                  #RESATTRs: Arn

AWS::SNS::Topic                   #Includes RESPROPs: Subscription OBJ_ARR: Protocol, Endpoint
                                  #Creates SUB but does not delete it, i.e. meant for SUBs created in other STACKs

new Subscription
 (...CARGS, CSUB_OPTS)            #CSUB
ICTOPIC.addSubscription(CCSUB)
 ->CSUB                           #
new PROTOCOLSubscription          #CCSUB. Each one is documented below
 (CSUB_OPTS.endpoint[, CSUB_OPTS])#Automatically sets CSUB_OPTS.topic|protocol|region

CSUB_OPTS.topic                   #ICTOPIC. SUB.TopicArn
CSUB_OPTS.protocol                #SUB.Protocol
CSUB_OPTS.endpoint                #SUB.Endpoint

CTOPIC.grantSubscribe(YGRANTABLE)
 ->CGRANT                         #Allows sns:Subscribe

                                  ┌─────────────┐
                                  │   CONFIRM   │
                                  └─────────────┘

SUB_CONFIRM                       #Confirms SUB creation
                                  #Whether used or not is PROTOCOL-specific (each documented below)
                                  #Cannot delete SUB while pending
                                  #Delete SUB after 2 days if no SUB_CONFIRM
                                  #Max 5e3 (soft) pending SUB_CONFIRMs per ACCOUNT
SUB_CONFIRM.TopicArn              #'TOPIC_ARN'

NOTIFICATION.Type                 #Can be:
                                  #  - 'Notification': on Publish()
                                  #  - 'SubscriptionConfirmation': on Subscribe(), if SUB_CONFIRM needed
                                  #  - 'UnsubscribeConfirmation': on anonymous Unsubscribe()

SUB_CONFIRM                       #'BOOL'. Whether Unsubscribe():
 .AuthenticateOnUnsubscribe       #  - 'true': must be called in TOPIC|SUB.Owner's ACCOUNT_ID
                                  #  - 'false' (def): can be anonymous (no AWS signature)
                                  #ConfirmSubscription() itself can always be anonymous
                                  #  - if so, AuthenticateOnUnsubscribe cannot be set, i.e. must remain 'false'
                                  #Anonymous ConfirmSubscription|Unsubscribe():
                                  #  - can use GET method, i.e. provide as URL
                                  #    'https://sns.REGION.amazonaws.com/?Action=ConfirmSubscription|Unsubscribe&PARAM=VAL'
                                  #  - not logged to CloudTrail
SUB_ATTRS
 .ConfirmationWasAuthenticated    #BOOL. Whether SUB_CONFIRM was authenticated

NOTIFICATION.Token                #STR. Only set if NOTIFICATION.Type '*Confirmation'
SUB_CONFIRM.Token                 #NOTIFICATION.Token. Authenticate anonymous ConfirmSubscription()
                                  #Not used by Unsubscribe()
                                  #  - however, forging requires knowing TOPIC_MID, ACCOUNT_ID and REGION

NOTIFICATION.SubscribeURL         #'URL' to anonymous ConfirmSubscription(), including NOTIFICATION.Token
                                  #I.e. 'https://sns.REGION.amazonaws.com/?Action=ConfirmSubscription&TopicArn=TOPIC_ARN&Token=STR'
                                  #Only if NOTIFICATION.Type '*Confirmation'
NOTIFICATION.UnsubscribeURL       #'URL' to anonymous Unsubscribe()
                                  #I.e. 'https://sns.REGION.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=SUB_ARN'
                                  #With any NOTIFICATION.Type

SUB_ATTRS.PendingConfirmation     #BOOL. Whether SUB_CONFIRM done
TOPIC_ATTRS.SubscriptionsPending  #NUM of pending SUB_CONFIRMs
TOPIC_ATTRS.SubscriptionsConfirmed#NUM of ConfirmSubscription()

SUB.ReturnSubscriptionArn         #BOOL. If false (def), SUB.SubscriptionArn is 'pending confirmation' instead, if SUB_CONFIRM needed

                                  ┌─────────────────┐
                                  │   CONFIRM API   │
                                  └─────────────────┘

ConfirmSubscription()             #Req: SUB_CONFIRM
                                  #Res: SUB
                                  #  - only SubscriptionArn

                                  ┌─────────────────────┐
                                  │   CONFIRM METRICS   │
                                  └─────────────────────┘

AWS/Usage/ResourceCount           #NUM of pending SUB_CONFIRMs
                                  #With DVAR Resource 'ApproximateNumberOfPendingSubscriptions'

                                  ┌────────────┐
                                  │   FILTER   │
                                  └────────────┘

SUB_ATTRS.FilterPolicy            #'FILTERS_JSON'. Filter which NOTIFICATIONs to receive
                                  #Updates take up to 15m to enter into effect
                                  #Max 200 per TOPIC (soft), 1e4 per ACCOUNT (soft)
                                  #Max 256KB

SUB_ATTRS.FilterPolicyScope       #Whether FILTERS are applied on:
                                  #  - 'MessageAttributes' (def)
                                  #     - not with DataType 'Binary'
                                  #  - 'MessageBody': must be JSON

FILTERS.*                         #And'd, i.e. must all match
                                  #Empty MESSAGEs never match, even FILTER.exists false
FILTERS.$or                       #FILTERS_ARR
                                  #Can be combined with FILTERS.*, e.g. { PROP: ARR, $or: FILTERS_ARR }
                                  #Can be nested
                                  #Min 2 items

FILTERS.PROP[.PROP...]            #Filters depending on FilterPolicyScope:
                                  #  - MessageAttributes: MESSAGE_ATTRS.PROP
                                  #  - MessageBody: MESSAGE_BODY.PROP[.PROP...]
                                  #ARR of either:
                                  #  - STR|NUM|BOOL|null: ARR.includes() (case-sensitive)
                                  #  - FILTER (ARR has a single item)
                                  #Max 5 PROPs
                                  #Max 150 complexity, where complexity is the cartesian product of all FILTERS.*:
                                  #  - NUM of PROPs (key)
                                  #  - NUM of ARR items (value)
                                  #  - if nested $or, compute its complexity recursively

FILTER.anything-but               #ARR|FILTER. !ARR.includes() (case-sensitive)
FILTER.equals-ignore-case         #STR. === (case-insensitive)
FILTER.numeric                    #['OP', NUM[, 'OP2', NUM2]]
                                  #OP is = > >= < <=
                                  #Min|max NUM [-]1e9, 5 decimal points
FILTER.exists                     #BOOL. !==|=== null|undefined
FILTER.prefix|suffix              #STR. startsWith|endsWith(STR)
FILTER.cidr                       #'CIDR'. Matches IP

DATATYPE ARRAY ==>                #If DataType '*.Array':
                                  #  - matches if any item does, i.e. ARR2.some(VAL => ...): FILTER.anything-but
                                  #  - matches if all items do, i.e. ARR2.every(VAL => ...): ARR (ARR.includes())

                                  ┌────────────────┐
                                  │   FILTER IAC   │
                                  └────────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: FilterPolicy OBJ, FilterDeliveryScope

CSUB_OPTS.filterPolicy.PROP       #CFILTER, when SUB_ATTRS.FilterPolicyScope 'MessageAttributes'
CSUB_OPTS
 .filterPolicyWithMessageBody
 .PROP                            #CNESTED_FILTER, when SUB_ATTRS.FilterPolicyScope 'MessageBody'

FilterOrPolicy.filter
 (CFILTER)->CNESTED_FILTER        #FILTERS.PROP
FilterOrPolicy.policy
 ({PROP: CNESTED_FILTER, ...})
 ->CNESTED_FILTER2                #FILTERS.PROP.PROP...

new SubscriptionFilter(ARR)       #CFILTER. FILTERS.PROP
                                  #Passes an ARR of VAL or FILTER

SubscriptionFilter.stringFilter
 (OPTS)->CFILTER                  #
OPTS.allowlist                    #ARR of VALs
OPTS.denylist                     #ARR. {anything-but: ARR}
OPTS.matchesPrefixes|Suffixes     #STR_ARR. Multiple {prefix|suffix: STR}

SubscriptionFilter.numericFilter
 (OPTS)->CFILTER                  #
OPTS.less|greaterThan[OrEqualTo]  #NUM. {numeric: ['OP', NUM]}
OPTS.between.start|stop           #NUM. {numeric: ['>=', NUM, '<=', NUM2]}
OPTS.betweenStrict.start|stop     #NUM. {numeric: ['>', NUM, '<', NUM2]}
OPTS.allowlist                    #ARR. Multiple {numeric: ['=', VAL]}

SubscriptionFilter.existsFilter()
 ->CFILTER                        #{exists: true}

                                  ┌────────────────────┐
                                  │   FILTER METRICS   │
                                  └────────────────────┘

AWS/SNS/
 NumberOfNotificationsFilteredOut #NUM of NOTIFICATIONs filtered out
AWS/SNS/
 NumberOfNotificationsFilteredOut
 -MessageAttributes               #NUM of NOTIFICATIONs filtered out by MESSAGE_ATTRs
AWS/SNS/
 NumberOfNotificationsFilteredOut
 -InvalidAttributes               #NUM of NOTIFICATIONs filtered out by MESSAGE_ATTRs due to them being invalid
AWS/SNS/
 NumberOfNotificationsFilteredOut
 -NoMessageAttributes             #NUM of NOTIFICATIONs filtered out by MESSAGE_ATTRs due to not having any
AWS/SNS/
 NumberOfNotificationsFilteredOut
 -MessageBody                     #NUM of NOTIFICATIONs filtered out by MESSAGE_BODY
AWS/SNS/
 NumberOfNotificationsFilteredOut
 -InvalidMessageBody              #NUM of NOTIFICATIONs filtered out by MESSAGE_BODY due to it being invalid

AWS/Usage/ResourceCount           #NUM of FILTER_POLICYs
                                  #With DVAR Resource 'ApproximateNumberOfFilterPolicies'

                                  ┌────────────────────────┐
                                  │   FILTER METRICS IAC   │
                                  └────────────────────────┘

ICTOPIC.metricNumberOf
 NotificationsFilteredOut
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Sum'
ICTOPIC.metricNumberOf
 NotificationsFilteredOut
 InvalidAttributes
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Sum'
ICTOPIC.metricNumberOf
 NotificationsFilteredOut
 NoMessageAttributes
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Sum'

                                  ┌──────────────┐
                                  │   THROTTLE   │
                                  └──────────────┘

MESSAGE THROTTLING ==>            #Max MESSAGEs per second to each TOPIC
                                  #Not API calls, i.e. regardless of Publish[Batch]()
                                  #Is:
                                  #  - same REGION: 30000|9000|1500|300 (REGION-specific, soft) and 20MB/s
                                  #  - cross-REGIONs: 1000 (soft) and 6MB/s
                                  #  - FIFO SQS: 300/s per MESSAGE_GROUP
                                  #  - SMS: 20 (soft)
                                  #  - email: 10

DELIVERY_POLICY.throttlePolicy    #NUM (def: unlimited). Max NOTIFICATIONs per second from TOPIC to this SUB
 .maxReceivesPerSecond            #If too low, can create a backlog of MESSAGEs available in TOPIC but not sent to SUB
                                  #  - dropped after 1h???

                                  ┌──────────────────┐
                                  │   THROTTLE IAC   │
                                  └──────────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: DeliveryPolicy: throttlePolicy

CDELIVERY_POLICY.throttlePolicy   #DELIVERY_POLICY.*

                                  ┌──────────────────────┐
                                  │   THROTTLE METRICS   │
                                  └──────────────────────┘

AWS/SNS/NumberOfMessagesPublished #NUM of MESSAGEs sent to TOPICs
                                  #cdk-monitoring-constructs:
                                  #  - sum: METRIC, summary WIDGET, MALARM Min|MaxNumberOfMessagesPublished <|> CXALARM_OPTS.min|maxMessagesPublishedCount

AWS/Usage/ResourceCount           #NUM of MESSAGEs sent to TOPICs
                                  #With DVAR Resource 'NumberOfMessagesPublishedPerAccount'

AWS/SNS/                          #NUM of NOTIFICATIONs successfully sent from TOPIC to SUBs
 NumberOfNotificationsDelivered   #Does not included filtered out MESSAGEs
                                  #Difference with AWS/SNS/NumberOfMessagesPublished is backlog
                                  #cdk-monitoring-constructs:
                                  #  - sum: METRIC, summary WIDGET

                                  ┌──────────────────────────┐
                                  │   THROTTLE METRICS IAC   │
                                  └──────────────────────────┘

ICTOPIC
 .metricNumberOfMessagesPublished
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Sum'

ICTOPIC.metricNumberOf
 NotificationsDelivered
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Sum'

                                  ┌───────────┐
                                  │   RETRY   │
                                  └───────────┘

TOPIC_ATTRS|SUB_ATTRS
 .DeliveryPolicy                  #'DELIVERY_POLICY_JSON'
TOPIC_ATTRS|SUB_ATTRS
 .EffectiveDeliveryPolicy         #Same but also shows default values
DELIVERY_POLICY.PROTOCOL          #PDELIVERY_POLICY
                                  #Only allowed PROTOCOL is 'http'. Other PROTOCOLs always use the default value

DELIVERY_POLICY.default*          #Instead of DELIVERY_POLICY.* when using TOPIC_ATTRS.DeliveryPolicy (as opposed to SUB_ATTRS.DeliveryPolicy)
DELIVERY_POLICY                   #BOOL (def: false). Ignores SUB_ATTRS.DeliveryPolicy, i.e. only use TOPIC_ATTRS.DeliveryPolicy
 .disableSubscriptionOverrides    #Seems to be undocumented

DELIVERY_POLICY.healthyRetryPolicy#RETRY_POLICY. How to retry when fail to send NOTIFICATIONs from TOPIC to SUB
                                  #NOTIFICATION is considered failed once no more retries
                                  #Retries "server-side errors":
                                  #  - could not reach endpoint
                                  #     - e.g. HTTP server down, or AWS outage
                                  #  - 5** response
                                  #Does not retry "client-side errors":
                                  #  - invalid API call
                                  #     - including no endpoint (e.g. deleted QUEUE)
                                  #  - AWS auth error
                                  #  - 4** response
RETRY_POLICY.minDelayTarget       #NUM (in secs, min 1). Retry start delay
                                  #Def 20s with HTTP, 10s with email|SMS|APP, 1s else
RETRY_POLICY.maxDelayTarget       #NUM (in secs, min minDelayTarget, max 1h). Retry end delay
                                  #Def 10m with email|SMS|APP, 20s else
RETRY_POLICY.numRetries           #NUM. Max retries, including all phases
                                  #Def 3 with HTTP, 50 with email|SMS|APP, 100_015 else
                                  #Max 100 with HTTP
RETRY_POLICY.numNoDelayRetries    #NUM. "Immediate retries": first phase, without any delay
                                  #Def 0 with HTTP|email|SMS|APP, 3 else
RETRY_POLICY.numMinDelayRetries   #NUM. "Pre-backoff retries": second phase, with minDelayTarget
                                  #Def 0 with HTTP, 2 else
RETRY_POLICY.backoffFunction      #"Backoff retries": third phase, going from minDelayTarget to maxDelayTarget
                                  #One of (from linear to very exponential):
                                  #  - 'LINEAR' (def with HTTP)
                                  #  - 'ARITHMETIC'
                                  #  - 'GEOMETRIC'
                                  #  - 'EXPONENTIAL' (def else)
RETRY_POLICY.numMaxDelayRetries   #NUM. "Post-backoff retries": fourth phase, with maxDelayTarget
                                  #Def 0 with HTTP, 38 with email|SMS|APP, 1e5 else

                                  ┌───────────────┐
                                  │   RETRY IAC   │
                                  └───────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: DeliveryPolicy: healthyRetryPolicy

CSUB_OPTS.deliveryPolicy          #CDELIVERY_POLICY. SUB_ATTRS.DeliveryPolicy
CDELIVERY_POLICY
 .healthyRetryPolicy              #CRETRY_POLICY. DELIVERY_POLICY.*
CRETRY_POLICY.min|maxDelayTarget  #DURATION
CRETRY_POLICY
 .num*Retries|backoffFunction     #RETRY_POLICY.*

                                  ┌───────────────────┐
                                  │   RETRY METRICS   │
                                  └───────────────────┘

AWS/SNS/                          #NUM of NOTIFICATIONs failed to be sent from TOPIC to SUBs
 NumberOfNotificationsFailed      #Does not included filtered out MESSAGEs
                                  #With HTTP, includes retries too
                                  #cdk-monitoring-constructs:
                                  #  - sum: METRIC, summary WIDGET, MALARM MessageNotificationsFailed > CXALARM_OPTS.maxNotificationsFailedCount

                                  ┌───────────────────────┐
                                  │   RETRY METRICS IAC   │
                                  └───────────────────────┘

ICTOPIC.metricNumberOf
 NotificationsFailed
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Sum'

                                  ┌───────────────────┐
                                  │   RETRY LOGGING   │
                                  └───────────────────┘

LRES.attempts                     #NUM of retry attempts

                                  ┌───────────────────────┐
                                  │   DEAD-LETTER QUEUE   │
                                  └───────────────────────┘

SUB_ATTRS.RedrivePolicy           #'REDRIVE_POLICY_JSON'. Sends failed NOTIFICATIONs to SQS DLQ
                                  #For both client|server-side errors
                                  #Not with SMS???

REDRIVE_POLICY.deadLetterTargetArn#'QUEUE_ARN'
                                  #Must have same ACCOUNT|REGION as SUB
                                  #Must be [non-]FIFO if TOPIC is [non-]FIFO

                                  ┌────────────────────────────┐
                                  │   DEAD-LETTER QUEUE AUTH   │
                                  └────────────────────────────┘

PACTION sqs:SendMessage           #Must be allowed:
                                  #  - on Resource QUEUE
                                  #  - on Principal.Service sns.amazonaws.com
                                  #  - COND_KEY aws:SourceArn TOPIC_ARN
                                  #Must also allow kms:* if using SSE-KMS

                                  ┌───────────────────────────────┐
                                  │   DEAD-LETTER QUEUE METRICS   │
                                  └───────────────────────────────┘

AWS/SNS/
NumberOfNotificationsRedrivenToDlq#NUM of NOTIFICATIONs moved to DLQ

AWS/SNS/NumberOfNotifications
 FailedToRedriveToDlq             #NUM of NOTIFICATIONs which failed to be moved to DLQ

                                  ┌───────────────────────────┐
                                  │   DEAD-LETTER QUEUE IAC   │
                                  └───────────────────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: RedrivePolicy: DeadLetterTargetArn

CSUB[_OPTS].deadLetterQueue       #ICQUEUE. SUB_ATTRS.RedrivePolicy
                                  #Automatically adds relevant permissions using CQUEUE_MPOLICY

                                  ┌────────────────────────────┐
                                  │   DEAD-LETTER QUEUE LINT   │
                                  └────────────────────────────┘

cfn-lint-serverless aws_sns_
 topic_subscription_redrive_policy
ES7000                            #SUB_ATTRS.RedrivePolicy must be set

                                  ┌─────────────┐
                                  │   MESSAGE   │
                                  └─────────────┘

MESSAGE                           #Payload sent from Publish*() to TOPIC
                                  #Max 256KB (soft)
                                  #Max header 16KB??? (soft)

MESSAGE_RES.MessageId             #'MESSAGE_MID'
MESSAGE.TopicArn                  #'TOPIC_ARN'

MESSAGE.Message                   #'MESSAGE_BODY'
MESSAGE.MessageStructure          #If 'json' (def: undefined), MESSAGE_BODY is 'OBJ_JSON' of {PROTOCOL|default: 'MESSAGE_BODY', ...}
                                  #I.e. PROTOCOL-specific MESSAGE_BODY
                                  #One `default` is required

MESSAGE
 .MessageAttributes.MESSAGE_ATTR  #ATTR_VALUE. Custom metadata
ATTR_VALUE.DataType               #Value's type among 'String[.Array]', 'Number[.Array]' or 'Binary'
                                  #Can append with any '.DESCRIPTION', e.g. 'Number.float', max 256 chars
ATTR_VALUE.StringValue            #STR. Value, when DataType 'String[.Array]|Number[.Array]'
                                  #'NUM' must be single-precision float
                                  #ARR is in JSON, i.e. '[NUM,...]' or '["STR",...]'
                                  #Must be [:print:]
ATTR_VALUE.BinaryValue            #STR. Value, when DataType 'Binary'
                                  #Must be base64'd

MESSAGE.Subject                   #STR. Title
                                  #Meaning is PROTOCOL-specific

DATA REDUNDANCY ==>               #MESSAGEs are replicated on multiple AZs

ORDER ==>                         #Best effort, might be out-of-order
                                  #Not with SQS FIFO

DOUBLE PROCESSING ==>             #Sometimes, a MESSAGE might be delivered to a SUB more than once
                                  #I.e. processing should be idempotent
                                  #Not with SQS FIFO

                                  ┌─────────────────┐
                                  │   MESSAGE API   │
                                  └─────────────────┘

Publish()                         #Req: MESSAGE
                                  #Res: MESSAGE_RES

                                  ┌─────────────────┐
                                  │   MESSAGE SDK   │
                                  └─────────────────┘

ATTR_VALUE.BinaryValue            #INPUT_BLOB|OUTPUT_BLOB

EXTENDED CLIENT LIBRARY ==>       #Client built on top of Java|Python SDK, that automatically uploads|downloads|cleans up
                                  #big payloads to S3, replacing MESSAGE_BODY with S3 URL
                                  #Only meant to get over the size limit, since it does not lower cost (replacing SNS costs with S3 costs)
                                  #Repository is awslabs/amazon-sns-python|java-extended-client-lib
                                  #Shared logic with SQS extended client libary is at awslabs/payload-offloading-java-common-lib-for-aws

                                  ┌─────────────────┐
                                  │   MESSAGE IAC   │
                                  └─────────────────┘

CTOPIC.grantPublish(YGRANTABLE)
 ->CGRANT                         #Allows sns:Publish

                                  ┌─────────────────┐
                                  │   MESSAGE SAM   │
                                  └─────────────────┘

SNSPublishMessagePolicy           #SAM POLICY_TEMPLATE (see its doc) that allows:
                                  #  - PACTION sns:Publish
                                  #  - on 'TOPIC'
                                  #     - using POLICY_TEMPLATE_PARAMS.TopicName

AWS::Serverless::Connector        #Can be used with:
                                  #  - Source: Lambda FUNCTION or Step Functions STATE_MACHINE (RESOURCE_REF.RoleName)
                                  #  - Destination: TOPIC (RESOURCE_REF.Arn)
                                  #  - Permissions 'Write'
                                  #Transformed to a MPOLICY on 'ROLE':
                                  #  - allowing sns:Publish
                                  #  - on TOPIC

AWS::Serverless::Connector        #Can be used with:
                                  #  - Source: EventBridge RULE (RESOURCE_REF.Arn)
                                  #  - Destination: TOPIC (RESOURCE_REF.Arn)
                                  #  - Permissions 'Write'
                                  #Transformed to a TOPIC_POLICY on TOPIC:
                                  #  - allowing SERVICE events.amazonaws.com
                                  #  - to sns:Publish
                                  #  - COND_KEY aws:SourceArn RULE_ARN

                                  ┌─────────────────────┐
                                  │   MESSAGE METRICS   │
                                  └─────────────────────┘

AWS/SNS/PublishSize               #Size of MESSAGEs
                                  #Excludes failed ones
                                  #cdk-monitoring-constructs:
                                  #  - average: METRIC, WIDGET

                                  ┌─────────────────────────┐
                                  │   MESSAGE METRICS IAC   │
                                  └─────────────────────────┘

ICTOPIC.metricPublishSize
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Average'

                                  ┌─────────────────────┐
                                  │   MESSAGE LOGGING   │
                                  └─────────────────────┘

CLOUDTRAIL ==>                    #Publish() is logged to CloudTrail as data EVENT
                                  #LOG_RESOURCE is:
                                  #  - APP_PLATFORM_TYPE if MESSAGE.TargetArn set
                                  #  - TOPIC else
                                  #Not logged if MESSAGE.PhoneNumber set

                                  ┌───────────┐
                                  │   BATCH   │
                                  └───────────┘

BATCH                             #Multiple MESSAGEs in a single API call
                                  #Max 10 entries (soft)
                                  #Max 256KB

BATCH.TopicArn                    #'TOPIC_ARN'
BATCH.PublishBatchRequestEntries  #BATCH_ENTRY_ARR
BATCH_ENTRY.Id                    #'BATCH_ENTRY_MID'. Required
                                  #Max 80 chars, [:alnum:]_-
BATCH_ENTRY.*                     #MESSAGE.* except no TopicArn, TargetArn, PhoneNumber

BATCH_RES.Successful              #BATCH_SUCCESS_ARR
BATCH_SUCCESS.Id                  #'BATCH_ENTRY_MID'
BATCH_SUCCESS.*                   #MESSAGE_RES

BATCH_RES.Failed                  #BATCH_ERROR_ARR
BATCH_ERROR.Id                    #'BATCH_ENTRY_MID'
BATCH_ERROR.Code                  #'CODE'
BATCH_ERROR.Message               #'MESSAGE'
BATCH_ERROR.SenderFault           #BOOL. Whether caused by user or by API

                                  ┌────────────────┐
                                  │   BATCH AUTH   │
                                  └────────────────┘

PACTION sqs:Publish               #Includes sns:PublishBatch, which does not have its own PACTION

                                  ┌───────────────┐
                                  │   BATCH API   │
                                  └───────────────┘

PublishBatch()                    #Req: BATCH
                                  #Res: BATCH_RES

                                  ┌───────────────────┐
                                  │   BATCH LOGGING   │
                                  └───────────────────┘

CLOUDTRAIL ==>                    #Like Publish()

                                  ┌──────────────────┐
                                  │   NOTIFICATION   │
                                  └──────────────────┘

NOTIFICATION                      #Payload sent from TOPIC to SUBs

SUB_ATTRS.RawMessageDelivery      #BOOL (def: false). Use MESSAGE_BODY itself as NOTIFICATION
                                  #As opposed to setting NOTIFICATION.* documented below
                                  #  - including NOTIFICATION.Message 'MESSAGE_BODY'

NOTIFICATION.Timestamp            #DATE_NUM

NOTIFICATION.Message              #MESSAGE.Message
                                  #Can JSON parse it using either
                                  #  - QUERY SNS JMESPath 'QUERY' (see its doc)
                                  #  - @middy/event-normalizer (see its doc)
                                  #     - including when invoked from SQS SUBSCRIPTION
NOTIFICATION.TopicArn|MessageId
 |MessageAttributes|Subject       #MESSAGE.*
NOTIFICATION.MessageAttributes    #MESSAGE_ATTRS except DataType -> Type, StringValue|BinaryValue -> Value

                                  ┌──────────────────────┐
                                  │   NOTIFICATION IAC   │
                                  └──────────────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: RawMessageDelivery

CSUB_OPTS.rawMessageDelivery      #SUB_ATTRS.RawMessageDelivery

CSUB_OPTS.json                    #BOOL (def: false). Whether 'PROTOCOL' is 'email' or 'email-json'
                                  #Only with new EmailSubscription()

                                  ┌───────────────┐
                                  │   INTEGRITY   │
                                  └───────────────┘

TOPIC_ATTRS|NOTIFICATION          #ALGO used for the integrity signature. Either:
 .SignatureVersion                #  - '1' (def): 'RSA-SHA1'
                                  #  - '2' (recommended): 'RSA-SHA256'

NOTIFICATION.SigningCertURL       #'https://sns.REGION.amazon.com/ID.pem' to PEM file
                                  #Should check that the URL follows this format, to avoid injection
                                  #Contents is 'PEM'
                                  #If fetched, should cache it for performance

NOTIFICATION.Signature            #'SIGNATURE_BASE64'. NOTIFICATION.* integrity signature

CRYPTO
 .createVerify('ALGO')
 .update('NOTIFICATION_ENTRIES')
 .verify('PEM',                   #Verifies integrity
 'SIGNATURE_BASE64', 'base64')    #Only useful if endpoint can be called by others than SNS
 ->BOOL                           #  - i.e. mostly useful for HTTP

NOTIFICATION_ENTRIES              #Ordered newline-separated list of NOTIFICATION.* key + value
                                  #For: Message, MessageId, Subject, SubscribeURL, Timestamp, Token (if any), TopicArn, Type
                                  #Not checked for integrity: MessageAttributes, UnsubscribeURL

                                  ┌───────────────────┐
                                  │   INTEGRITY SDK   │
                                  └───────────────────┘

sns-validator                     #Version 0.3.5
                                  #Has a few issues:
                                  #  - not well maintained
                                  #  - does not retry downloading 'PEM' on network error

new Validator                     #VALIDATOR
 ([REGEXP[, 'ENCODING']])         #Def REGEXP: /^sns\.[a-zA-Z0-9\-]{3,}\.amazonaws\.com(\.cn)?$/
                                  #Def ENCODING: 'utf8'

VALIDATOR.validate                #Checks NOTIFICATION.Signature
 (NOTIFICATION[_JSON],            #Also confirms that:
 FUNC([ERROR]))                   #  - NOTIFICATION shape is normal
                                  #  - NOTIFICATION.SigningCertURL is right domain name
                                  #Caches 'PEM' in-process

                                  ┌───────────────────┐
                                  │   INTEGRITY IAC   │
                                  └───────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: SignatureVersion

CTOPIC_OPTS.signatureVersion      #TOPIC_ATTRS.SignatureVersion

                                  ┌────────────────┐
                                  │   ENCRYPTION   │
                                  └────────────────┘

TOPIC_ATTRS.KmsMasterKeyId        #KMS_ID (def: none). "SSE". Encrypts MESSAGE_BODY at rest
                                  #Does not encrypt other parts of MESSAGE.* (e.g. MESSAGE_ATTRS)

                                  ┌─────────────────────┐
                                  │   ENCRYPTION AUTH   │
                                  └─────────────────────┘

PACTION
 kms:Decrypt|GenerateDataKey*     #Must be allowed if SSE

                                  ┌────────────────────┐
                                  │   ENCRYPTION IAC   │
                                  └────────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: KmsMasterKeyId

CTOPIC_OPTS.masterKey             #ICKEY. TOPIC_ATTRS.KmsMasterKeyId

CTOPIC_OPTS|CTOPIC_MPOLICY_OPTS   #BOOL (def: false, recommended: true). Adds a POLICY which denies sns:Publish on TOPIC from any PRINCIPAL
 .enforceSSL                      #if COND_KEY aws:SecureTransport false

                                  ┌─────────────────────┐
                                  │   ENCRYPTION LINT   │
                                  └─────────────────────┘

cdk-nag SNSTopicSSLPublishOnly    #Must set CTOPIC_OPTS.enforceSSL true, if SSE-KMS

                                  ┌─────────────┐
                                  │   LOGGING   │
                                  └─────────────┘

TOPIC_ATTRS                       #ROLE_ARN used to send to CloudWatch Logs, logging successful NOTIFICATIONs
 .PROTOCOLSuccessFeedbackRoleArn  #PROTOCOL is HTTP, Lambda, SQS, Firehose or Application
                                  #Not for email
                                  #TOPIC is sent as a logging TELEMETRY_ENTITY
TOPIC_ATTRS
 .PROTOCOLFailureFeedbackRoleArn  #Same for failed NOTIFICATIONs
TOPIC_ATTRS                       #0-100. Percentage of successful NOTIFICATIONs to log
.PROTOCOLSuccessFeedbackSampleRate#Failed NOTIFICATIONs are always logged

APP_PLATFORM_ATTRS.*              #Same as TOPIC_ATTRS.Application*
SMS_ATTRS.DeliveryStatusIAMRole
|DeliveryStatusSuccessSamplingRate#Same for SMS

sns/REGION/ACCOUNT_ID/TOPIC       #'LOG_GROUP'

LPAYLOAD                          #JSON LMESSAGE used in logs
LPAYLOAD.status                   #'SUCCESS|FAILURE'
LPAYLOAD.notification             #NOTIFICATION. Only timestamp|messageId|topicArn
LPAYLOAD.delivery                 #LRES
LRES.delivery                     #'REQ_ID'
LRES.destination                  #SUB.Endpoint
LRES.statusCode                   #STATUS_NUM from SUB response
LRES.providerResponse             #STR body from SUB response
LRES.dwellTimeMs                  #NUM (in ms). Duration between TOPIC and SUB
LRES.token                        #STR???

                                  ┌──────────────────┐
                                  │   LOGGING AUTH   │
                                  └──────────────────┘

PACTION iam:PassRole              #Must be allowed on current PRINCIPAL

PACTION logs:CreateLogGroup
 |CreateLogStream|PutLogEvents    #Must be allowed on success|failure ROLE

service-role/AmazonSNSRole        #AWS managed POLICY that allows PACTIONs:
                                  #  - logs:CreateLogGroup|PutMetricFilter|PutRetentionPolicy on any LOG_GROUP
                                  #  - logs:CreateLogStream|PutLogEvents on any LOG_STREAM

                                  ┌─────────────────┐
                                  │   LOGGING IAC   │
                                  └─────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: DeliveryStatusLogging OBJ_ARR:
                                  #  - Protocol 'PROTOCOL'
                                  #  - SuccessFeedbackRoleArn, FailureFeedbackRoleArn, SuccessFeedbackSampleRate

CTOPIC_OPTS.loggingConfigs        #LOGGING_ARR
LOGGING.protocol                  #'PROTOCOL'
LOGGING.successFeedbackRole       #ICROLE. TOPIC_ATTRS.PROTOCOLSuccessFeedbackRoleArn
LOGGING.failureFeedbackRole       #ICROLE. TOPIC_ATTRS.PROTOCOLFailureFeedbackRoleArn
LOGGING.successFeedbackSampleRate #NUM. TOPIC_ATTRS.PROTOCOLSuccessFeedbackSampleRate

                                  ┌────────────┐
                                  │   POLICY   │
                                  └────────────┘

TOPIC_ATTRS.Policy                #IAM 'POLICY_DOC'. TOPIC_POLICY
                                  #Resource-level on a TOPIC, i.e. Resource is TOPIC_ARN
                                  #Principal must be 'ACCOUNT_ID'
                                  #  - this can worked around using either:
                                  #     - COND_KEY aws:PrincipalArn or aws:SourceArn|SourceAccount
                                  #     - identity-level POLICY instead
                                  #Def:
                                  #  - allows PACTIONs sns:DeleteTopic|*TopicAttributes sns:Subscribe|ListsubscriptionsByTopic, sns:Publish, sns:*Permission
                                  #  - for any principal in current ACCOUNT: using Principal.AWS '*' + COND_KEY aws::SourceOwner 'ACCOUNT_ID'

PERMISSION                        #Sets TOPIC_ATTRS.Policy
                                  #POLICY_DOC.Id is 'arn:aws:sqs:REGION:ACCOUNT_ID/TOPIC/SNSDefaultPolicy'
PERMISSION.Label                  #STATEMENT.Sid
PERMISSION.TopicArn               #'TOPIC_ARN'. STATEMENT.Resource
PERMISSION.ActionName             #'PACTION|*'_ARR. STATEMENT.Actions
PERMISSION.AWSAccountIds          #'ACCOUNT_ID'_ARR. STATEMENT.Principal.AWS
                                  #Required

TOPIC_ATTRS|SUB.Owner             #'ACCOUNT_ID'
SUB_ATTRS.SubscriptionPrincipal   #ARN of principal who created SUB

                                  ┌─────────────────┐
                                  │   POLICY AUTH   │
                                  └─────────────────┘

CROSS-ACCOUNT REQUESTS ==>        #Allowed by using Pricipal with another ACCOUNT, in TOPIC_POLICY
                                  #Only for PACTIONs sns:Subscribe|ListSubscriptionsByTopic (others???)

ANONYMOUS REQUESTS ==>            #Allowed by using Principal '*', in TOPIC_POLICY

PACTION sns:AddPermission
 |RemovePermission                #Do not require PACTION sns:SetTopicAttributes, even though they set TOPIC_ATTRS.Policy

                                  ┌────────────────┐
                                  │   POLICY API   │
                                  └────────────────┘

AddPermission()                   #Req: PERMISSION
                                  #Res: empty
RemovePermission()                #Req: PERMISSION
                                  #  - only TopicArn, Label
                                  #Res: empty

                                  ┌────────────────┐
                                  │   POLICY IAC   │
                                  └────────────────┘

AWS::SNS::TopicInlinePolicy       #RESPROPs: PolicyDocument POLICY_DOC_OBJ, TopicArn 'TOPIC_ARN'
                                  #Is TOPIC_ATTRS.Policy, i.e. resource-level
                                  #With Cloud Control, cannot list

AWS::SNS::TopicPolicy             #RESPROPs: PolicyDocument POLICY_DOC_OBJ, Topics 'TOPIC_ARN'_ARR
                                  #RESATTR: Id POLICY_MID
                                  #Is a MPOLICY, i.e. identity-level
                                  #With Cloud Control, cannot read|list

new TopicPolicy(...CARGS, OPTS)   #CTOPIC_MPOLICY. AWS::SNS::TopicPolicy
OPTS.policyDocument
CTOPIC_MPOLICY.document           #CPOLICY_DOC (def: empty one)
OPTS.topics                       #ICTOPIC_ARR

CTOPIC                            #Is RGRANTABLE, using CTOPIC_MPOLICY
                                  #If ICTOPIC, is RGRANTABLE but noop
CTOPIC.grant*(...)                #Uses identity-based POLICY or (if fails) CTOPIC_MPOLICY
                                  #If cross-ACCOUNT, uses both

                                  ┌─────────────────┐
                                  │   MASK POLICY   │
                                  └─────────────────┘

TOPIC.DataProtectionPolicy        #'MASK_POLICY_JSON'
                                  #Handle sensitive data in MESSAGEs
                                  #Max 30KB

MASK_POLICY
 .Version|Name|Description        #Same as CloudWatch Logs
MASK_POLICY.Statement             #MASK_STATEMENT_ARR
MASK_STATEMENT.Sid                #'MASK_STATEMENT'
MASK_STATEMENT.Principal          #Like IAM STATEMENT.Principal, including '*'
                                  #If DataDirection:
                                  #  - 'Inbound': who called Publish*()
                                  #  - 'Outbound': who called Subscribe(), i.e. SUB_ATTRS.SubscriptionPrincipal
MASK_STATEMENT.DataDirection      #Applied on MESSAGEs sent:
                                  #  - 'Inbound': by Publish*() to TOPIC
                                  #  - 'Outbound': by TOPIC to SUB
MASK_STATEMENT.Operation          #MASK_OP

MASK_OP.Deidentify.MaskConfig
 .MaskWithCharacter               #Mask the value with 'CHAR'

MASK_OP.Deidentify.RedactConfig   #Delete the value

MASK_OP.Deny                      #Empty OBJ. Reject the MESSAGE

                                  ┌─────────────────────┐
                                  │   MASK POLICY API   │
                                  └─────────────────────┘

PutDataProtectionPolicy()         #Req: TOPIC
                                  #  - only DataProtectionPolicy, TopicArn -> ResourceArn
                                  #Res: empty
GetDataProtectionPolicy()         #Req: TOPIC
                                  #  - only TopicArn -> ResourceArn
                                  #Res: TOPIC
                                  #  - only DataProtectionPolicy

                                  ┌─────────────────────┐
                                  │   MASK POLICY IAC   │
                                  └─────────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: DataProtectionPolicy MASK_POLICY_OBJ

                                  ┌──────────────────────┐
                                  │   MASK DESTINATION   │
                                  └──────────────────────┘

MASK_OP.Audit                     #MASK_DESTINATION
 .FindingsDestination             #Send masked values to a destination
MASK_OP.Audit                     #MASK_DESTINATION
 .NoFindingsDestination           #Send MESSAGE to a destination when no marked values

MASK_OP.Audit.SampleRate          #0 to 100 (def). Only applied on NUM% of MESSAGEs

MASK_DESTINATION
 .CloudWatchLogs|S3|Firehose      #Like CloudWatch Logs, except 'LOG_GROUP' must start with '/aws/vendedlogs/'

MPAYLOAD                          #Payload sent to MASK_DESTINATION
MPAYLOAD.auditTimestamp           #'DATE'
MPAYLOAD.resourceArn              #TOPIC_ARN
MPAYLOAD.messageId                #'MESSAGE_MID'
MPAYLOAD.callerPrincipal          #MASK_STATEMENT.Principal
MPAYLOAD.dataIdentifiers          #DDATAID_ARR, like CloudWatch Logs

                                  ┌───────────────────────────┐
                                  │   MASK DESTINATION AUTH   │
                                  └───────────────────────────┘

PACTION logs:CreateLogDelivery
 |UpdateLogDelivery
 |ListLogDeliveries
 |GetLogDelivery
 |DeleteLogDelivery               #Required for MASK_DESTINATION
PACTION logs:PutResourcePolicy
 |DescribeResourcePolicies
 |DescribeLogGroups               #Required for MASK_DESTINATION.CloudWatchLogs.LogGroup
PACTION s3:PutBucketPolicy        #Required for MASK_DESTINATION.S3.Bucket
 |GetBucketPolicy                 #Also kms:* if SSE-KMS
PACTION
 iam:CreateServiceLinkedRole
PACTION firehose:TagDeliveryStream#Required for MASK_DESTINATION.Firehose.DeliveryStream

                                  ┌──────────────────────────────┐
                                  │   MASK DESTINATION METRICS   │
                                  └──────────────────────────────┘

AWS/SNS/MessagesWith[No]Findings  #NUM of MESSAGEs matching MASK_OP.Audit.[No]FindingsDestination
                                  #Requires MASK_OP.Audit

                                  ┌──────────┐
                                  │   HTTP   │
                                  └──────────┘

SUB.Protocol                      #'http[s]'. Send using HTTP[S] request, with POST
                                  #15s timeout
                                  #Supports SNI
                                  #Can use HTTP basic|digest auth
SUB.Endpoint                      #'http[s]://...' to send to

SUB_CONFIRM                       #Always required

DELIVERY_POLICY                   #Content-Type [C] of NOTIFICATIONs
 .requestPolicy.headerContentType #'MIME' among 'text/plain' (def), 'application/json', 'application/xml'
                                  #If SUB_ATTRS.RawMessageDelivery true, can also be 'text/html|css|xml|csv',
                                  #'application/octet-stream', 'application/x-www-form-urlencoded' or 'application/atom|soap|xhtml+xml'

x-amz-sns-message-type [C]        #NOTIFICATION.Type
x-amz-sns-message-id [C]          #NOTIFICATION.MessageId
x-amz-sns-topic-arn [C]           #NOTIFICATION.TopicArn
x-amz-sns-subscription-arn [C]    #'SUB_ARN'
x-amz-sns-rawdelivery: true [C]   #Set if SUB_ATTRS.RawMessageDelivery true (see above)

                                  ┌──────────────┐
                                  │   HTTP IAC   │
                                  └──────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: DeliveryPolicy: requestPolicy

new UrlSubscription               #CCSUB
 ('URL'[, CSUB_OPTS])             #Def CSUB_OPTS.protocol: uses 'URL' scheme

CDELIVERY_POLICY.requestPolicy    #DELIVERY_POLICY.*

                                  ┌────────────┐
                                  │   LAMBDA   │
                                  └────────────┘

SUB.Protocol                      #'lambda'. Send to a Lambda FUNCTION
                                  #Not with FIFO
SUB.Endpoint                      #'FUNC_ARN'

SUB_ATTRS.RawMessageDelivery      #Cannot be set. Always behave as if false

INVOCATION ==>                    #InvocationType 'Event'
                                  #No response

NOTIFICATION.*Url                 #Named like this instead of NOTIFICATION.*URL

CROSS-ACCOUNT ==>                 #FUNCTION can be in different ACCOUNT than principal calling Subscribe(), but sends SUB_CONFIRM then

CROSS-REGION ==>                  #FUNCTION can be in different REGION than TOPIC|SUB
                                  #If same ACCOUNT, SNS API calls must be made in TOPIC|SUB's REGION, not FUNCTION's
OPT-IN REGIONS ==>                #FUNCTION's REGION cannot be opt-in

                                  ┌─────────────────┐
                                  │   LAMBDA AUTH   │
                                  └─────────────────┘

PACTION lambda:InvokeFunction     #Must be allowed:
                                  #  - Resource FUNCTION
                                  #  - Principal.Service 'sns[.REGION].amazonaws.com'
                                  #     - REGION is required if TOPIC|SUB's REGION is opt-in
                                  #  - COND_KEY aws:SourceArn TOPIC_ARN

                                  ┌────────────────┐
                                  │   LAMBDA IAC   │
                                  └────────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: Region 'REGION' (of the TOPIC)
                                  #  - def: SUB's REGION, i.e. only needed if QUEUE is in another REGION
                                  #If TOPIC is in a different STACK, FUNCTION must also DependsOn TOPIC

CSUB_OPTS.region                  #'REGION'

new LambdaSubscription            #CCSUB
 (ICANYFUNC[, CSUB_OPTS])         #Automatically adds relevant permissions using Lambda PERMISSION

new SnsEventSource                #Same as ICTOPIC.addSubscription(new LambdaSubcription(...))
 (ICTOPIC[, CSUB_OPTS])           #But is a CCEVENT_SOURCE, i.e. passed to Lambda CFUNCTION_OPTS.events instead

                                  ┌────────────────┐
                                  │   LAMBDA SAM   │
                                  └────────────────┘

AWS::Serverless::Function         #Includes RESPROPs: Events.EVENT: Type 'SNS', Properties: Topic, Region, FilterPolicy[Scope], RedrivePolicy
                                  #Creates:
                                  #  - Lambda SUB 'FUNCTION{EVENT}'
                                  #  - Lambda PERMISSION 'FUNCTION{EVENT}Permission'

AWS::Serverless::Connector        #Can be used with:
                                  #  - Source: TOPIC (RESOURCE_REF.Arn)
                                  #  - Destination: Lambda FUNCTION (RESOURCE_REF.Arn)
                                  #  - Permissions 'Write'
                                  #Transformed to a Lambda PERMISSION on FUNCTION:
                                  #  - allowing SERVICE sns.amazonaws.com
                                  #  - to lambda:InvokeFunction
                                  #  - aws:SourceArn TOPIC_ARN

                                  ┌────────────────────┐
                                  │   LAMBDA PAYLOAD   │
                                  └────────────────────┘

REQ.Records                       #LRECORD_ARR. Only one item???
LRECORD.EventVersion              #Always '1.0'
LRECORD.EventSource               #Always 'aws:sns'
LRECORD.EventSubscriptionArn      #'SUB_ARN'
LRECORD.Sns                       #NOTIFICATION

                                  ┌─────────┐
                                  │   SQS   │
                                  └─────────┘

SUB.Protocol                      #'sqs'. Send to a SQS QUEUE
SUB.Endpoint                      #'QUEUE_ARN'
                                  #Cannot use SSE-KMS

MESSAGE_BODY                      #Is NOTIFICATION

SUB_ATTRS.RawMessageDelivery      #If true, max 10 MESSAGE_ATTRs

CROSS-ACCOUNT ==>                 #Like Lambda, including for SUB_CONFIRM
CROSS-REGION ==>                  #Like Lambda
OPT-IN REGIONS ==>                #QUEUE's and TOPIC|SUB's REGIONs cannot be both opt-in at the same time

                                  ┌──────────────┐
                                  │   SQS AUTH   │
                                  └──────────────┘

PACTION sqs:SendMessage           #Must be allowed:
                                  #  - Resource QUEUE
                                  #  - Principal.Service 'sns[.REGION].amazonaws.com'
                                  #     - REGION is required if either QUEUE or TOPIC|SUB's REGION is opt-in
                                  #  - COND_KEY aws:SourceArn TOPIC_ARN
                                  #Also kms:Decrypt|GenerateDataKey, if SSE-KMS

                                  ┌─────────────┐
                                  │   SQS CLI   │
                                  └─────────────┘

sqs_grep                          #Can be used to copy SQS NOTIFICATIONs back to SNS
                                  #See its doc

                                  ┌─────────────┐
                                  │   SQS IAC   │
                                  └─────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: Region (like Lambda, see above)
                                  #Must DependsOn QUEUE
                                  #If TOPIC is in a different STACK, QUEUE must also DependsOn TOPIC

CSUB_OPTS.region                  #'REGION' (like Lambda, see above)

new SqsSubscription               #CCSUB
 (ICQUEUE[, CSUB_OPTS])           #Automatically adds relevant permissions using CQUEUE_MPOLICY
FFLAG @aws-cdk
 /aws-sns-subscriptions           #BOOL (recommended, def: false)
 :restrictSqsDescryption          #When allowing kms:* (due to SSE-KMS), use COND_KEY aws:SourceArn TOPIC_ARN

                                  ┌─────────────┐
                                  │   SQS SAM   │
                                  └─────────────┘

AWS::Serverless::Function         #Includes RESPROPs: Events.EVENT: Type 'SNS', Properties: Topic, Region, FilterPolicy[Scope], RedrivePolicy, SqsSubscription
                                  #SqsSubscription is either:
                                  #  - OBJ:
                                  #     - QueueArn, QueueUrl: both required
                                  #     - Enabled, BatchSize: EVENT_SOURCE.*
                                  #  - true: like OBJ, but automatically creates QUEUE
                                  #Creates:
                                  #  - SQS SUB 'FUNCTION{EVENT}'
                                  #  - AWS::SQS::QueuePolicy 'FUNCTION{EVENT}Policy': name can be overridden with SqsSubscription.QueuePolicyLogicalId
                                  #  - Lambda SOURCE_MAPPING 'FUNCTION{EVENT}EventSourceMapping'

AWS::Serverless::Connector        #Can be used with:
                                  #  - Source: TOPIC (RESOURCE_REF.Arn)
                                  #  - Destination: SQS QUEUE (RESOURCE_REF.Arn + RESOURCE_REF.QueueUrl)
                                  #  - Permissions 'Write'
                                  #Transformed to a QUEUE_POLICY on QUEUE (from QueueUrl):
                                  #  - allowing SERVICE sns.amazonaws.com
                                  #  - to sqs:SendMessage
                                  #  - on QUEUE2 (from Arn)
                                  #  - COND_KEY aws:SourceArn TOPIC_ARN

                                  ┌──────────────────┐
                                  │   SQS COMPOSER   │
                                  └──────────────────┘

TOPIC ENHANCEMENT COMPONENT ==>   #Can connect to SQS enhanced component to create SUB

                                  ┌──────────────┐
                                  │   SQS FIFO   │
                                  └──────────────┘

TOPIC_ATTRS.FifoTopic             #BOOL (def: false). Whether is FIFO TOPIC
                                  #'TOPIC' must end with '.fifo'
                                  #Only with SQS
                                  #QUEUE can be FIFO or not

ORDER ==>                         #Ensures that receiving order is same as sending order

MESSAGE.MessageGroupId            #Like SQS. 'MESSAGE_GROUP_ID' is forwarded to SQS too
MESSAGE_RES.SequenceNumber        #Like SQS
MESSAGE.MessageDeduplicationId
TOPIC_ATTRS                       #Like SQS. 'MESSAGE_DID' is forwarded to SQS too
 .ContentBasedDeduplication       #Not if SUB_ATTRS.FilterPolicy set

                                  ┌──────────────────┐
                                  │   SQS FIFO IAC   │
                                  └──────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: FifoTopic, ContentBasedDeduplication

CTOPIC[_OPTS].fifo                #TOPIC_ATTRS.FifoTopic
                                  #Automatically appends '.fifo' to 'TOPIC'
CTOPIC[_OPTS]
 .contentBasedDeduplication       #TOPIC_ATTRS.ContentBasedDeduplication

                                  ┌────────────────┐
                                  │   SQS REPLAY   │
                                  └────────────────┘

TOPIC_ATTRS.ArchivePolicy         #NUM (in days, min|def 0, max 1y).
 .MessageRetentionPeriod          #Stores MESSAGEs ("archive"), in order to re-send them
                                  #Keep MESSAGEs as is, including Timestamp, MessageId, etc.
                                  #Regardless of SUBs, i.e. of FILTERS, NOTIFICATIONs failures, etc.
                                  #Possible goals:
                                  #  - replication
                                  #  - retry failed NOTIFICATIONs, similar to DLQ
                                  #If set, cannot delete TOPIC
                                  #Only with FIFO
TOPIC_ATTRS.BeginningArchiveTime  #DATE_NUM. Earliest time to replay from, based on MessageRetentionPeriod

SUB_ATTRS.ReplayPolicy            #'REPLAY_JSON'. Re-sends MESSAGEs stored in TOPIC
                                  #Setting it triggers the re-sending
                                  #When re-sending done, still set
                                  #Since only with FIFO, pauses while re-sending
                                  #  - i.e. new MESSAGEs are archived and not sent to SUBs
                                  #Every SUB settings applies to the re-sent MESSAGEs, including FILTERS
REPLAY.PointType                  #Always 'Timestamp'
REPLAY.StartingPoint              #'DATE'
REPLAY.EndingPoint                #'DATE'. If not set, once done:
                                  #  - any MESSAGE archive while re-sending was happening are replayed too
                                  #  - then unpauses
                                  #If set, once done:
                                  #  - keeps it paused
                                  #  - can unpause can setting ReplayPolicy again but with:
                                  #     - StartingPoint with same value as previous EndpointPoint
                                  #     - no EndingPoint

SUB_ATTRS.ReplayStatus            #'Pending', 'In progress', 'Completed' or 'Failed'

NOTIFICATION.Replayed             #true when replayed

                                  ┌─────────────────────┐
                                  │   SQS REPLAY AUTH   │
                                  └─────────────────────┘

PACTION
 kms:Decrypt|GenerateDataKey*     #Must be allowed to Principal.Service 'sns.amazonaws.com' if SSE

                                  ┌────────────────────┐
                                  │   SQS REPLAY IAC   │
                                  └────────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: ArchivePolicy, ReplayPolicy OBJ

CTOPIC_OPTS
 .messageRetentionPeriodInDays    #TOPIC_ATTRS.ArchivePolicy.MessageRetentionPeriod

                                  ┌────────────────────────┐
                                  │   SQS REPLAY METRICS   │
                                  └────────────────────────┘

AWS/SNS/ApproximateNumberOf
 MessagesArchived                 #NUM of archived MESSAGEs

AWS/SNS/ApproximateNumberOf
 BytesArchived                    #Size (in bytes) of archived MESSAGEs

AWS/SNS/NumberOf
 MessagesArchiveProcessing
AWS/SNS/NumberOf
 BytesArchiveProcessing           #Same as both above but using StorageResolution 'high' instead of 'regular'

AWS/SNS/NumberOf
 ReplayedNotificationsDelivered   #NUM of MESSAGEs successfully replayed
AWS/SNS/NumberOf
 ReplayedNotificationsFailed      #NUM of MESSAGEs that failed to replay

                                  ┌─────────────┐
                                  │   KINESIS   │
                                  └─────────────┘

SUB.Protocol                      #'firehose'. Send to Kinesis Firehose delivery stream
                                  #Max 5 per DELIVERY_STREAM's ACCOUNT + TOPIC
SUB.Endpoint                      #'DELIVERY_STREAM_ARN'

CROSS-ACCOUNT ==>                 #Like Lambda, including for SUB_CONFIRM
CROSS-REGION ==>                  #Like Lambda
OPT-IN REGIONS ==>                #DELIVERY_STREAM's and TOPIC|SUB's REGIONs cannot be both opt-in at the same time

                                  ┌──────────────────┐
                                  │   KINESIS AUTH   │
                                  └──────────────────┘

SUB_ATTRS.SubscriptionRoleArn     #ROLE_ARN used to write to Firehose delivery stream
                                  #Must be assumable by sns[.REGION].amazonaws.com
                                  #  - REGION is required if either QUEUE or TOPIC|SUB's REGION is opt-in

PACTION iam:PassRole              #Must be allowed on current principal

                                  ┌─────────────────┐
                                  │   KINESIS IAC   │
                                  └─────────────────┘

AWS::SNS::Subscription            #Includes RESPROPs: Region (like Lambda, see above), SubscriptionRoleArn

CSUB_OPTS.region                  #'REGION' (like Lambda, see above)
CSUB_OPTS.subscriptionRoleArn     #SUB_ATTRS.SubscriptionRoleArn

                                  ┌───────────┐
                                  │   EMAIL   │
                                  └───────────┘

SUB.Protocol                      #'email[-json]'. Send as email (SMTP)
                                  #Sent from no-reply@sns.amazonaws.com
SUB.Endpoint                      #'EMAIL_ADDRESS'

SUB_ATTRS.RawMessageDelivery      #Must use PROTOCOL 'email' (false) vs 'email-json' (true) instead

SUB_CONFIRM                       #Required. NOTIFICATION with Type '*Confirmation' is sent as email with links instead

TOPIC_ATTRS.DisplayName           #'From' email field
                                  #Def: 'AWS Notifications Message'
                                  #Max 100 chars, [:alnum:]-_
MESSAGE.Subject                   #'Subject' email field
                                  #Def: 'AWS Notification Message'
                                  #Max 100 chars, no control characters nor newlines

                                  ┌───────────────┐
                                  │   EMAIL IAC   │
                                  └───────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: DisplayName

new EmailSubscription
 ('EMAIL_ADDRESS'[, CSUB_OPTS])   #CCSUB

CTOPIC_OPTS.displayName           #TOPIC_ATTRS.*

                                  ┌──────────────────┐
                                  │   SMS SETTINGS   │
                                  └──────────────────┘

SUB.Protocol                      #'sms'. Send an SMS
SUB.Endpoint                      #'PHONE_NUMBER'
                                  #E.164 format, i.e. use + followed by multiple digits
MESSAGE.PhoneNumber               #'PHONE_NUMBER', specified instead of MESSAGE.TopicArn
                                  #I.e. send a MESSAGE without using a TOPIC

SUB_ATTRS.RawMessageDelivery      #Cannot be set. Always behave as if true

SUB_CONFIRM                       #Required. NOTIFICATION with Type '*Confirmation' is sent as SMS instead
                                  #Must send SMS back: "Yes DISPLAY_NAME" (ConfirmSubscription()), "Stop" (Unsubscribe())

SMS_UI_SETTINGS                   #Submitted via UI when exiting the sandbox
                                  #SMS_UI_SETTINGS keys are only for documentation, since it is done via UI
SMS_UI_SETTINGS.SenderRegion      #'REGION'
SMS_UI_SETTINGS.ReceiverRegions   #'REGION'_ARR
SMS_UI_SETTINGS.ReceiverCountries #'COUNTRY'_ARR
SMS_UI_SETTINGS.AppLocation       #STR. Website URL or app name

SMS_SETTINGS.attributes           #SMS_ATTRS
SMS_ATTRS.DefaultSenderID         #STR. Sender field
                                  #Max 11 chars, [:alnum:] (at least one letter)
TOPIC_ATTRS.DisplayName           #STR. Use first 10 chars uppercased as start of SMS body, followed by >
                                  #Max 100 chars, [:alnum:]-_
MESSAGE.Message                   #STR. SMS contents
                                  #Each 140 ASCII (or 70 UTF-16) chars (cut at whitespaces) create a separate part
                                  #Max 1600 chars
MESSAGE.Subject                   #If set, used as MESSAGE.Message
SMS_UI_SETTINGS.MessageTemplates  #???

SMS_ATTRS.DefaultSMSType          #Either:
                                  #  - 'Promotional' (def): marketing, cheaper
                                  #  - 'Transactional': application, more reliable
                                  #  - 'Premium'???
SMS_UI_SETTINGS.DefaultSMSType    #'Promotional', 'Transactional' or 'OneTimePassword'

SMS_ATTRS|SMS_UI_SETTINGS         #Max NUM of USD to spend
 .MonthlySpendLimit               #Def: undocumented??? Max 1 USD (soft) per ACCOUNT???

SMS_ATTRS.UsageReportS3Bucket     #'BUCKET'. Logs successful NOTIFICATIONs as an OBJECT
                                  #Once per day
                                  #Is a CSV file with NOTIFICATION rows and SMS_USAGE columns
SMS_USAGE[0]                      #NOTIFICATION.Timestamp
SMS_USAGE[1]                      #NOTIFICATION.MessageId
SMS_USAGE[2]                      #'PHONE_NUMBER'
SMS_USAGE[3]                      #SMS_ATTRS.DefaultSMSType
SMS_USAGE[4]                      #STR. Delivery status???
SMS_USAGE[5]                      #NUM. Price in USD
SMS_USAGE[6]                      #NUM. Part number
SMS_USAGE[7]                      #NUM. Total number of parts

                                  ┌───────────────────────┐
                                  │   SMS SETTINGS AUTH   │
                                  └───────────────────────┘

PACTION s3:ListBucket             #For SMS_ATTRS.UsageReportS3Bucket, must be allowed:
 |GetBucketLocation|PutObject     #  - on Resource BUCKET_ARN
                                  #  - for Principal.Service sns.amazonaws.com

                                  ┌──────────────────────┐
                                  │   SMS SETTINGS API   │
                                  └──────────────────────┘

SetSMSAttributes()                #Req: SMS_SETTINGS
                                  #Res: empty
GetSMSAttributes()                #Req: SMS_SETTINGS
                                  #  - attributes OBJ -> 'SMS_ATTR'_ARR
                                  #Res: SMS_SETTINGS

                                  ┌──────────────────────┐
                                  │   SMS SETTINGS IAC   │
                                  └──────────────────────┘

AWS::SNS::Topic                   #Includes RESPROPs: DisplayName

new SmsSubscription
 ('PHONE_NUMBER'[, CSUB_OPTS])    #CCSUB

CTOPIC_OPTS.displayName           #TOPIC_ATTRS.*

                                  ┌──────────────────────────┐
                                  │   SMS SETTINGS METRICS   │
                                  └──────────────────────────┘

AWS/SNS/SMSSuccessRate            #NUM/s of SMSs sent

AWS/SNS/SMSMonthToDateSpentUSD    #NUM of USD charged for sending SMS since start of month

DVAR PhoneNumber                  #'PHONE_NUMBER'
                                  #Only when using MESSAGE.PhoneNumber
                                  #Sent with all METRICs except AWS/SNS/SMSMonthToDateSpentUSD
DVAR Country                      #Destination 'COUNTRY'
                                  #Sent with all METRICs except AWS/SNS/SMSMonthToDateSpentUSD|SMSSuccessRate
DVAR SMSType                      #SMS_ATTRS.DefaultSMSType
                                  #Sent with all METRICs except AWS/SNS/SMSMonthToDateSpentUSD|SMSSuccessRate

                                  ┌──────────────────────────────┐
                                  │   SMS SETTINGS METRICS IAC   │
                                  └──────────────────────────────┘

ICTOPIC.metricSMSSuccessRate
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Sum'
ICTOPIC
 .metricSMSMonthToDateSpentUSD
 ([CMETRIC_OPTS])->CMETRIC        #Uses statistic 'Maximum'

                                  ┌────────────────┐
                                  │   SMS SENDER   │
                                  └────────────────┘

SMS_SENDER                        #Phone number used when sending SMS
SMS_SENDER.CreatedAt              #DATE_NUM
SMS_SENDER.PhoneNumber            #'PHONE_NUMBER'

SMS_SENDER.Iso2CountryCode        #'COUNTRY_CODE' (2 chars, ISO 3166-1 alpha-2)
SMS_SENDER.NumberCapabilities     #STR_ARR among 'SMS', 'MMS', 'VOICE'
SMS_SENDER.RouteType              #SMS_ATTRS.DefaultSMSType
SMS_SENDER.Status                 #'ACTIVE' or 'INACTIVE'

                                  ┌────────────────────┐
                                  │   SMS SENDER API   │
                                  └────────────────────┘

ListOriginationNumbers()          #Req: empty
                                  #Res: PhoneNumbers SMS_SENDER_ARR

                                  ┌───────────────┐
                                  │   SMS ALLOW   │
                                  └───────────────┘

SMS_UI_SETTINGS.OptInMethod       #How receivers opt in to SMSs???

SMS_BLOCK.phoneNumber             #'PHONE_NUMBER'
SMS_BLOCK.isOptedOut              #BOOL. Whether PHONE_NUMBER blocked our number
                                  #Can be set from false to true, but only once per PHONE_NUMER per 30 days

                                  ┌───────────────────┐
                                  │   SMS ALLOW API   │
                                  └───────────────────┘

OptInPhoneNumber()                #Req: SMS_BLOCK
                                  #  - no isOptedOut
                                  #Res: empty
ListPhoneNumbersOptedOut()        #Req: empty
                                  #Res: phoneNumbers 'PHONE_NUMBER'_ARR
CheckIfPhoneNumberIsOptedOut()    #Req: SMS_BLOCK
                                  #  - no isOptedOut
                                  #Res: SMS_BLOCK
                                  #  - only isOptedOut

                                  ┌─────────────────┐
                                  │   SMS SANDBOX   │
                                  └─────────────────┘

SMS_SANDBOX.IsInSandbox           #BOOL. Wheter in sandbox
                                  #ACCOUNT is initially in sandbox
                                  #Per REGION

EXITING THE SANDBOX ==>           #Test at least one SMS_SANDBOX_RECEIVER
                                  #Then create a AWS Support case to exit the sandbox
                                  #  - under "Service quota increase" > "SNS Text Messaging"
                                  #Takes up to 24h

                                  ┌─────────────────────┐
                                  │   SMS SANDBOX API   │
                                  └─────────────────────┘

GetSMSSandboxAccountStatus()      #Req: empty
                                  #Res: SMS_SANDBOX

                                  ┌──────────────────────────┐
                                  │   SMS SANDBOX RECEIVER   │
                                  └──────────────────────────┘

SMS_SANDBOX_RECEIVER              #When in sandbox, can only send to SMS_SANDBOX_RECEIVERs
                                  #I.e. requires OTP confirmation from receivers
SMS_SANDBOX_RECEIVER.PhoneNumber  #'PHONE_NUMBER'

SMS_SANDBOX_RECEIVER              #STR. Token allowing receiving SMSs
 .OneTimePassword                 #Sent by CreateSMSSandboxPhoneNumber(), must be confirmed by VerifySMSSandboxPhoneNumber()
                                  #5-8 digits
SMS_SANDBOX_RECEIVER.LanguageCode #Language used with the token's SMS
                                  #Among "en-US|GB", "es-ES|419", "de-DE", "fr-CA|FR", "it-IT", "ja-JP", "pt-BR", "kr-KR", "zh-CN|TW"
SMS_SANDBOX_RECEIVER.Status       #'Pending' or 'Verified'. Whether confirmed with token

                                  ┌──────────────────────────────┐
                                  │   SMS SANDBOX RECEIVER API   │
                                  └──────────────────────────────┘

CreateSMSSandboxPhoneNumber()     #Req: SMS_SANDBOX_RECEIVER
                                  #  - no Status
                                  #Res: empty
VerifySMSSandboxPhoneNumber()     #Req: SMS_SANDBOX_RECEIVER
                                  #  - only PhoneNumber
                                  #  - only one with OneTimePassword
                                  #Res: empty
ListSMSSandboxPhoneNumbers()      #Req: empty
                                  #Res: PhoneNumbers SMS_SANDBOX_RECEIVER_ARR
                                  #  - no LanguageCode
DeleteSMSSandboxPhoneNumber()     #Req: SMS_SANDBOX_RECEIVER
                                  #  - only PhoneNumber
                                  #Res: empty

                                  ┌──────────────────┐
                                  │   APP ENDPOINT   │
                                  └──────────────────┘

SUB.Protocol                      #'application'. Send as a mobile|desktop push notification
SUB.Endpoint
APP_ENDPOINT.EndpointArn          #'APP_ENDPOINT_ARN'
MESSAGE.TargetArn                 #'APP_ENDPOINT_ARN', specified instead of MESSAGE.TopicArn
                                  #I.e. send a MESSAGE without using a TOPIC
APP_ENDPOINT.Attributes           #APP_ENDPOINT_ATTRS

SUB_ATTRS.RawMessageDelivery      #Cannot be set. Always behave as if true

SUB_CONFIRM                       #Not used

APP_ENDPOINT                      #Mobile device
                                  #Creating is idempotent

APP_ENDPOINT_ATTRS.Enabled        #BOOL. False until 'APP_TOKEN' set
APP_ENDPOINT.Token                #'APP_TOKEN'

APP_ENDPOINT.CustomUserData       #STR. Arbitrary data???
                                  #Max 2KB

APP_PLATFORM_ATTRS
 .EventEndpointCreated            #'TOPIC_ARN'. Send MESSAGEs on CreatePlatformEndpoint()
APP_PLATFORM_ATTRS
 .EventEndpointUpdated            #'TOPIC_ARN'. Send MESSAGEs on SetEndpointAttributes()
APP_PLATFORM_ATTRS
 .EventEndpointDeleted            #'TOPIC_ARN'. Send MESSAGEs on DeleteEndpoint()
APP_PLATFORM_ATTRS
 .EventDeliveryFailure            #'TOPIC_ARN'. Send MESSAGEs on push failure

                                  ┌──────────────────────┐
                                  │   APP ENDPOINT API   │
                                  └──────────────────────┘

CreatePlatformEndpoint()          #Req: APP_ENDPOINT
                                  #  - no EndpointArn
                                  #Res: APP_ENDPOINT
                                  #  - only EndpointArn
SetEndpointAttributes()           #Req: APP_ENDPOINT
                                  #  - only EndpointArn, Attributes
                                  #  - CustomUserData|Token -> Attributes.*
                                  #Res: empty
ListEndpointsByPlatformApplication#Req: APP_ENDPOINT
 ()                               #  - only PlatformApplicationArn
                                  #Res: Endpoints APP_ENDPOINT_ARR
                                  #  - only EndpointArn, Attributes
GetEndpointAttributes()           #Req: APP_ENDPOINT
                                  #  - only Attributes
                                  #  - CustomUserData|Token -> Attributes.*
                                  #Res: empty
DeleteEndpoint()                  #Req: APP_ENDPOINT
                                  #  - only EndpointArn
                                  #Res: empty

                                  ┌──────────────────┐
                                  │   APP PLATFORM   │
                                  └──────────────────┘

APP_PLATFORM                      #Push notification settings
APP_ENDPOINT|APP_PLATFORM
 .PlatformApplicationArn          #'APP_PLATFORM_ARN'. 'arn:aws:sns:REGION:ACCOUNT_ID:app/APP_PLATFORM_TYPE/APP_PLATFORM'
APP_PLATFORM.Name                 #'APP_PLATFORM'
                                  #Max 256 chars, [:alnum:]_-.
APP_PLATFORM.Attributes           #APP_PLATFORM_ATTRS

APP_PLATFORM.Platform             #'APP_PLATFORM_TYPE'. Listed below
APP_PLATFORM_ATTRS
 .AuthenticationMethod            #Same???

APP_PLATFORM_ATTRS
 .PlatformPrincipal               #APP_PLATFORM_TYPE-specific developer ID
APP_PLATFORM_ATTRS
 .PlatformCredential              #APP_PLATFORM_TYPE-specific developer secret key

                                  ┌──────────────────────────┐
                                  │   APP PLATFORM ANDROID   │
                                  └──────────────────────────┘

APP_PLATFORM.Platform             #'GCM' (Firebase Cloud Messaging)
                                  #For Android|iOS, web app and Chrome app/extensions, using Google Cloud
APP_PLATFORM_ATTRS
 .PlatformPrincipal               #None
APP_PLATFORM_ATTRS                #Either:
 .PlatformCredential              #  - API key
                                  #  - JSON private key file

                                  ┌────────────────────────┐
                                  │   APP PLATFORM CHINA   │
                                  └────────────────────────┘

APP_PLATFORM.Platform             #'BAIDU' (Baidu Cloud Push)
                                  #For Android in China
APP_PLATFORM_ATTRS
 .PlatformPrincipal               #Public API key
APP_PLATFORM_ATTRS
 .PlatformCredential              #Secret key

                                  ┌────────────────────────┐
                                  │   APP PLATFORM APPLE   │
                                  └────────────────────────┘

APP_PLATFORM.Platform             #'APNS[_SANDBOX]' (Apple Push Notification Service)
                                  #For iOS and Mac OS X
APP_PLATFORM_ATTRS                #Either:
 .PlatformPrincipal               #  - SSL certificate
                                  #  - signing key ID
APP_PLATFORM_ATTRS                #If using PlatformPrincipal:
 .PlatformCredential              #  - SSL certificate: private key
                                  #  - signing key ID: signing key

APP_PLATFORM_ATTRS
 .ApplePlatformTeamID             #STR. Apple developer account team ID
APP_PLATFORM_ATTRS
 .ApplePlatformBundleID           #STR. iOS app ID
APP_PLATFORM_ATTRS
 .AppleCertificateExpiryDate      #DATE_NUM of SSL certificate expiration

                                  ┌────────────────────────────────┐
                                  │   APP PLATFORM WINDOWS PHONE   │
                                  └────────────────────────────────┘

APP_PLATFORM.Platform             #'MPNS' (Microsoft Push Notification Service)
                                  #For Windows Phone
APP_PLATFORM_ATTRS
 .PlatformPrincipal               #TLS certificate
APP_PLATFORM_ATTRS
 .PlatformCredential              #Private key

                                  ┌──────────────────────────────────┐
                                  │   APP PLATFORM WINDOWS DESKTOP   │
                                  └──────────────────────────────────┘

APP_PLATFORM.Platform             #'WNS' (Windows Push Notification Services)
                                  #For Windows desktop
APP_PLATFORM_ATTRS
 .PlatformPrincipal               #Package Security Identifier
APP_PLATFORM_ATTRS
 .PlatformCredential              #Secret key

                                  ┌─────────────────────────┐
                                  │   APP PLATFORM KINDLE   │
                                  └─────────────────────────┘

APP_PLATFORM.Platform             #'ADM' (Amazon Device Messaging)
                                  #For Kindle
APP_PLATFORM_ATTRS
 .PlatformPrincipal               #Client ID
APP_PLATFORM_ATTRS
 .PlatformCredential              #Client secret

                                  ┌──────────────────────┐
                                  │   APP PLATFORM API   │
                                  └──────────────────────┘

CreatePlatformApplication()       #Req: APP_PLATFORM
                                  #  - no PlatformApplicationArn
                                  #  - Attributes: no AppleCertificateExpiryDate, AuthenticationMethod,
                                  #    *FeedbackRoleArn, SuccessFeedbackSampleRate
                                  #Res: APP_PLATFORM
                                  #  - only PlatformApplicationArn
SetPlatformApplicationAttributes()#Req: APP_PLATFORM
                                  #  - only PlatformApplicationArn, Attributes
                                  #  - Attributes: no AppleCertificateExpiryDate, AuthenticationMethod,
                                  #    *FeedbackRoleArn, SuccessFeedbackSampleRate
                                  #Res: empty
ListPlatformApplications()        #Req: empty
                                  #Res: PlatformApplications APP_PLATFORM_ARR
                                  #  - only PlatformApplicationArn, Attributes
GetPlatformApplicationAttributes()#Req: APP_PLATFORM
                                  #  - only PlatformApplicationArn
                                  #Res: APP_PLATFORM
                                  #  - only Attributes: no PlatformCredential, PlatformPrincipal
DeletePlatformApplication()       #Req: APP_PLATFORM
                                  #  - only PlatformApplicationArn
                                  #Res: empty

                                  ┌──────────────────────────┐
                                  │   APP PLATFORM METRICS   │
                                  └──────────────────────────┘

DVAR Application                  #'APP_PLATFORM'
                                  #Sent with all METRICs except AWS/SNS/SMSMonthToDateSpentUSD|SMSSuccessRate
DVAR Platform                     #'APP_PLATFORM_TYPE'
                                  #Sent with all METRICs except AWS/SNS/SMSMonthToDateSpentUSD|SMSSuccessRate

                                  ┌───────────┐
                                  │   LOCAL   │
                                  └───────────┘

goaws                             #See its doc

MESSAGE_ATTRS.AWS.SNS.MOBILE
 .APP_PLATFORM_TYPE               #MMESSAGE

MMESSAGE.TTL                      #???
                                  #Also for APP_PLATFORM_TYPE:
                                  #  - APNS_MDM|APNS_PASSBOOK|APNS_VOIP[_SANDBOX]
                                  #  - MACOS[_SANDBOX]

MMESAGE.DeployStatus
MMESAGE.MessageKey
MMESAGE.MessageType               #Only with Baidu???

MMESSAGE.COLLAPSE_ID
MMESSAGE.PRIORITY
MMESSAGE.PUSH_TYPE
MMESSAGE.TOPIC                    #Only with Apple???

MMESAGE.NotificationClass
MMESAGE.Type                      #Only with Windows phone???

MMESSAGE.CachePolicy
MMESSAGE.Group
MMESSAGE.Match
MMESSAGE.SuppressPopup
MMESSAGE.Tag
MMESSAGE.Type                     #Only with Windows desktop???
